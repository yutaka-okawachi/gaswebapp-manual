# データ同期ワークフロー (Sync Workflow)

このプロジェクトでは、ローカルのスプレッドシート関連データ（JSON）とGoogle Apps Script (GAS) を同期するために、`sync-data.ps1` スクリプトを使用します。

## スクリプトの概要

`sync-data.ps1` は以下の処理を一括で行います：

1.  **Git状態チェックと自動ブランチ切り替え**: 実行開始時に Git の状態を確認します。
    -   **異常状態の検知**: Rebase 中や Detached HEAD などの不安定な状態では、安全のため処理を中止し、解決方法を提示します。
    -   **自動ブランチ切り替え**: 現在のブランチが `main` でない場合、未コミットの変更がないことを確認した上で、自動的に `main` ブランチへ切り替えます。
2.  **環境変数の読み込み**: `.env` ファイルから `GAS_DEPLOY_URL` と `GAS_SECRET_TOKEN` を読み込みます。
3.  **ソースコードの変更チェック**: `src/` ディレクトリに変更があるか確認します。
4.  **GASへのプッシュ (必要時)**: 変更がある場合、`clasp push` を実行して GAS にコードをアップロードします。
5.  **新しいデプロイの作成 (必要時)**: コードが更新された場合、新しいバージョンをデプロイし、ウェブアプリの URL を更新します。
6.  **データの同期**: GAS ウェブアプリのエンドポイント (`exportAllDataToJson`) を叩き、最新のデータを JSON としてダウンロードして `data/` ディレクトリに保存します。

## 実行方法

PowerShell で以下のコマンドを実行してください。

```powershell
.\sync-data.ps1
```

## トラブルシューティング

-   **404 エラー**: ウェブアプリの URL が古い可能性があります。`.env` ファイルの `GAS_DEPLOY_URL` が最新のデプロイを指しているか確認してください。
-   **認証エラー**: `.env` の `GAS_SECRET_TOKEN` が、GAS のスクリプトプロパティ `TOKEN` と一致しているか確認してください。
