# データ同期ワークフロー (Sync Workflow)

このプロジェクトでは、ローカルのスプレッドシート関連データ（JSON）とGoogle Apps Script (GAS) を同期するために、`sync-data.ps1` スクリプトを使用します。

## スクリプトの概要

`sync-data.ps1` は以下の処理を一括で行います：

1.  **Git状態チェックと自動ブランチ切り替え**: 実行開始時に Git の状態を確認します。
    -   **異常状態の検知**: Rebase 中や Detached HEAD などの不安定な状態では、安全のため処理を中止し、解決方法を提示します。
    -   **自動ブランチ切り替え**: 現在のブランチが `main` でない場合、未コミットの変更がないことを確認した上で、自動的に `main` ブランチへ切り替えます。
2.  **環境変数の読み込み**: `.env` ファイルから `GAS_DEPLOY_URL` と `GAS_SECRET_TOKEN` を読み込みます。
3.  **ソースコードの変更チェック**: `src/` ディレクトリに変更があるか確認します。
4.  **GASへのプッシュ (必要時)**: 変更がある場合、`clasp push` を実行します。認証エラー時は再ログインを促します。
5.  **デプロイの更新 (必要時)**: `src/manage_deploy.js` が実行され、現在 `.env` に設定されているデプロイメントIDを対象にバージョンを更新します（URLは維持されます）。
6.  **フロントエンド設定の同期**: `mahler-search-app/js/app.js` 内の通知先 URL 設定を `.env` と同期させます。
7.  **データの同期**: GAS ウェブアプリのエンドポイントを叩き、最新データをダウンロードします。ここで `clasp run` が失敗し、かつ認証リトライも失敗した場合に限り、自動的にWeb App経由にフォールバックします。フォールバック時には必要に応じてデプロイ更新を行います。
8.  **中間コミット (必要時)**: 同期処理中に `app.js` 等が更新された場合、自動的にコミットを作成し、後続の `git pull` エラーを防ぎます。

## 実行方法

PowerShell で以下のコマンドを実行してください。

```powershell
.\sync-data.ps1
```

## トラブルシューティング

-   **404 エラー**: ウェブアプリの URL が古い可能性があります。`.env` ファイルの `GAS_DEPLOY_URL` が最新のデプロイを指しているか確認してください。
-   **認証エラー**: `.env` の `GAS_SECRET_TOKEN` が、GAS のスクリプトプロパティ `TOKEN` と一致しているか確認してください。
