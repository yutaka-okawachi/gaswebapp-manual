<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用語から検索 (RW)</title>
    <link rel="stylesheet" href="css/common_terms.css">
    <script src="js/app.js"></script>
    <script>
        function debounce(func, delay) {
            let timer; return function (...args) { clearTimeout(timer); timer = setTimeout(() => func.apply(this, args), delay); };
        }
        let currentSearchId = 0;
        let termEntries = []; // { original, normalized } の配列

        window.addEventListener('DOMContentLoaded', async () => {
            const inputField = document.getElementById('termInput');
            inputField.addEventListener('input', debouncedOnTermInput);

            // Load data locally first
            if (typeof loadData === 'function') {
                await loadData('rw_terms_search');
            }

            // ページ読み込み時に全用語リストを取得し、以降はクライアント側でサジェスト
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(terms => {
                        termEntries = (Array.isArray(terms) ? terms : [])
                            .map(term => normalizeTermEntry(term))
                            .filter(Boolean);
                        console.log(`${termEntries.length}件のRW用語を読み込みました。`);
                    })
                    .withFailureHandler(err => {
                        console.error('RW用語の取得に失敗しました:', err);
                        termEntries = [];
                    })
                    .getRWTermsForClient();
            } else {
                // Local fallback
                termEntries = getTermsListLocal('RW');
                console.log(`Loaded ${termEntries.length} RW terms locally.`);
            }
        });

        const debouncedOnTermInput = debounce((event) => {
            const input = event.target.value.trim();
            if (input.length < 2) { document.getElementById('termSuggestions').innerHTML = ''; return; }

            const normalizedInput = normalizeString(input);
            const matches = termEntries
                .filter(entry => entry.normalized.includes(normalizedInput))
                .sort((a, b) => a.normalized.localeCompare(b.normalized));

            updateDatalist(matches);
        }, 300);
        function updateDatalist(suggestions) {
            const datalist = document.getElementById('termSuggestions');
            datalist.innerHTML = '';
            (suggestions || []).forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.normalized;
                datalist.appendChild(option);
            });
        }
        function search() {
            const query = document.getElementById('termInput').value.trim();
            const resultsDiv = document.getElementById('results');
            const loadingHtml = '<p class=\"loading\">検索中・・・</p>';
            resultsDiv.innerHTML = loadingHtml;
            focusResultsPanel({ instant: true });
            if (!query) {
                resultsDiv.innerHTML = '<p class=\"result-message\">用語を入力してください</p>';
                focusResultsPanel({ instant: true });
                return;
            }
            currentSearchId++; const thisSearchId = currentSearchId;

            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(html => {
                    if (thisSearchId === currentSearchId) {
                        resultsDiv.innerHTML = html;
                        focusResultsPanel({ instant: true });
                    }
                }).searchRWTerms(query);
            } else {
                // Local fallback
                setTimeout(() => {
                    if (thisSearchId === currentSearchId) {
                        const html = searchTermsLocal(query, 'RW');
                        resultsDiv.innerHTML = html;
                        focusResultsPanel({ instant: true });
                    }
                }, 10);
            }
        }

        function normalizeTermEntry(term) {
            if (typeof term === 'string') {
                const trimmed = term.trim();
                return trimmed ? { original: trimmed, normalized: normalizeString(trimmed) } : null;
            }
            if (term && typeof term === 'object') {
                const original = typeof term.original === 'string' ? term.original.trim() : '';
                if (!original) return null;
                const normalized = typeof term.normalized === 'string'
                    ? term.normalized.trim().toLowerCase()
                    : '';
                return { original, normalized: normalized || normalizeString(original) };
            }
            return null;
        }

        // normalizeString is in app.js
        // But if we want to be safe in case app.js is not loaded or we want to be standalone-ish
        // Since we include app.js, we should use it.
        // If we redefine it, it might conflict if let/const, but function declaration overrides or is hoisted.
        // app.js has it as function declaration.
        // I will remove it from here to rely on app.js, or check if exists.
        // Actually, to be safe, I'll just rely on app.js.
        // Wait, if app.js fails to load for some reason, this script will fail anyway.

        function cancelSearch() { document.getElementById('results').innerHTML = '<p class="loading">検索を中止しました</p>'; currentSearchId++; }
        function clearInput() { document.getElementById('termInput').value = ''; document.getElementById('termSuggestions').innerHTML = ''; document.getElementById('results').innerHTML = ''; }
    </script>
</head>

<body>
    <div class="container">
        <h1>用語から検索 (RW)</h1>
        <p><b>用語集は<a href="https://sites.google.com/site/brucknermahleryinleyongyu/%E7%94%A8%E8%AA%9E%E9%9B%86"
                    target="_blank">こちら</a></b></p>
        <p>検索は英字入力なので，特殊文字の入力は慣例にしたがう</p>
        <ul>
            <li>ä⇒ae　例：Dämpfer⇒Daempfer</li>
            <li>ü⇒ue　例：zurückhalten⇒zurueckhalten</li>
            <li>ö⇒oe　例：Flöte⇒Floete</li>
            <li>ß⇒ss　例：fließend⇒fliessend</li>
        </ul>

        <input type="text" id="termInput" list="termSuggestions" placeholder="用語を入力">
        <datalist id="termSuggestions"></datalist>

        <div style="text-align: center;">
            <button type="button" onclick="search()" class="btn-search">検索</button>
            <button type="button" onclick="cancelSearch()" class="btn-danger">中止</button>
            <button type="button" onclick="clearInput()" class="clear-input-btn">クリア</button>
        </div>

        <div id="results"></div>
    </div>

    <div id="scrollToTop" onclick="scrollToTop()">▲ ページのトップへ戻る</div>
</body>

</html>