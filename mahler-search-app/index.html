<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <!-- レスポンシブ対応 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>データ検索</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap');

    /*
 * common_styles.html
 * 全ページで共通して使用される基本的なスタイルシート。
 */
    :root {
      --primary-bg: #fffaf7;
      --container-bg: #fff;
      --title-bg: #ffdce0;
      --title-border: #e35d76;
      --section-label-bg: #ffe9cc;
      --results-bg: #fff2e0;
      --button-bg: #1a73e8;
      --button-hover-bg: #1557b0;
      --button-active-bg: #174ea6;
      --danger-button-bg: #dc3545;
      --danger-button-hover-bg: #c82333;
      --clear-button-bg: #6c757d;
      --clear-button-hover-bg: #5a6268;
      --clear-input-btn-bg: #e9ecef;
      --clear-input-btn-hover-bg: #dde2e6;
      --input-border: #79a9f2;
      --input-bg: #f4faff;
      --text-color: #333;
      --placeholder-color: #aaa;
      --section-title-color: #1a73e8;
      --focus-ring-color: #1a73e8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: var(--primary-bg);
      line-height: 1.6;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: var(--container-bg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-height: 70vh;
      border-radius: 10px;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      padding: 10px;
      text-align: center;
      background-color: var(--title-bg);
      border-bottom: 6px solid var(--title-border);
      border-radius: 6px;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.2rem;
      }
    }

    /* セクションタイトルの強調 */
    .section-title {
      font-size: 1.2em;
      font-weight: 600;
      padding: 0.5em;
      margin: 1.5em 0 1em;
      border-left: 4px solid var(--section-title-color);
      background: #f8f9fa;
      border-radius: 0 4px 4px 0;
    }

    .big-label {
      font-size: 1.2rem;
      margin: 1.5rem 0;
      padding: 8px;
      background-color: var(--section-label-bg);
      border-radius: 5px;
      font-weight: bold;
    }

    p,
    ul {
      margin: 10px 0;
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--text-color);
    }

    ul {
      .result-de {
        font-weight: bold;
        font-size: 1.2em;
        line-height: 1.45;
        display: block;
        font-family: 'Lora', serif;
      }

      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 10px;
      background-color: #fafafa;
    }

    fieldset {
      border: none;
      padding: 15px;
      border-radius: 10px;
      background-color: #f8fafd;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 15px;
    }

    legend {
      display: none;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 20px;
    }

    /* 曲名リストを縦並びにするためのスタイル */
    .radio-group#opera-selection {
      display: block;
    }

    .radio-group label {
      display: block;
      margin-bottom: 8px;
      font-family: Georgia, serif;
      font-size: 0.95rem;
      /* フォントサイズを少し小さく調整 */
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 5px 15px;
      font-family: Georgia, serif;
      font-size: 0.95rem;
    }

    .checkbox-group hr {
      grid-column: 1 / -1;
      width: 100%;
      border: 0;
      border-top: 1px solid #ccc;
      margin: 5px 0;
    }

    .checkbox-group label {
      display: block;
      margin-bottom: 5px;
      font-family: inherit;
    }

    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(0.9);
    }

    input[type="checkbox"]:checked+label,
    input[type="radio"]:checked+label {
      color: var(--button-bg);
      font-weight: 500;
    }

    /* アコーディオンスタイル */
    details.instrument-group {
      margin: 0.5em 0;
      border-radius: 4px;
    }

    details.instrument-group summary {
      padding: 0.4em 0.6em;
      font-size: 0.9em;
      cursor: pointer;
      background: #f8f9fa;
      border: 1px solid #eee;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    details.instrument-group summary:hover {
      background: #f0f2f5;
    }

    details.instrument-group[open] summary {
      background: #e8f0fe;
      border-color: #d2e3fc;
    }

    .accordion-content {
      display: none;
      margin-top: 10px;
    }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1rem;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      background-color: var(--input-bg);
    }

    input::placeholder {
      color: var(--placeholder-color);
      opacity: 1;
    }

    .button-container {
      text-align: center;
      margin-top: 20px;
    }

    button {
      margin: 6px 4px;
      padding: 6px 12px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.08);
      background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.1));
    }

    button:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    button:active {
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      transform: translateY(1px);
      filter: brightness(0.95);
      background-image: linear-gradient(to top, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.1));
    }

    button.btn-search,
    button.btn-action {
      background-color: var(--button-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    button.btn-search:hover,
    button.btn-action:hover {
      background-color: var(--button-hover-bg);
    }

    button.btn-search:active,
    button.btn-action:active {
      background-color: var(--button-active-bg);
    }

    button.btn-danger {
      background-color: var(--danger-button-bg);
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    button.btn-danger:hover {
      background-color: var(--danger-button-hover-bg);
    }

    button.btn-clear {
      background-color: var(--clear-button-bg);
      border: 1px solid rgba(108, 117, 125, 0.2);
    }

    button.btn-clear:hover {
      background-color: var(--clear-button-hover-bg);
    }

    /* ボタンが無効化されたときのスタイル */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none !important;
      transform: none !important;
      filter: grayscale(20%) !important;
      background-image: none !important;
    }

    button.clear-input-btn {
      background-color: var(--clear-input-btn-bg);
    }

    button.clear-input-btn:hover {
      background-color: var(--clear-input-btn-hover-bg);
    }

    .loading,
    .result-message {
      font-family: 'Lora', serif;
      font-size: 1.0em;
      font-weight: bold;
      text-align: center;
      padding: 20px;
    }

    #results {
      margin-top: 20px;
      background-color: var(--results-bg);
      padding: 10px;
      border-radius: 5px;
      min-height: 150px;
      line-height: 1.5;
      white-space: normal;
      font-family: 'Lora', serif;
      font-size: 0.92em;
    }

    #results>div:first-child {
      margin-bottom: 15px;
    }

    .scene-title {
      font-size: 1.2em;
      font-weight: bold;
      padding-bottom: 4px;
      border-bottom: 2px solid #ccc;
      margin-top: 1.2em;
      margin-bottom: 10px;
    }

    .result-entry {
      display: flex;
      align-items: baseline;
      margin-bottom: 0.6em;
      font-size: 0.92em;
    }

    .result-page {
      flex: 0 0 4em;
      font-weight: normal;
      color: #555;
      white-space: nowrap;
      font-size: 0.85em;
    }

    .result-content {
      flex: 1;
    }

    .result-de {
      font-weight: bold;
      font-size: 1.2em;
      line-height: 1.45;
      display: block;
      font-family: 'Lora', serif;
    }

    .result-ja-loc {
      display: block;
      font-size: 1.0em;
      font-weight: normal;
      margin-top: 2px;
      font-family: 'Lora', serif;
    }

    .result-ja-loc span:last-child {
      margin-left: 0.5em;
      font-size: 0.84em;
      color: #444;
    }

    /* 出典・件数の表示（index.html に合わせる） */
    .result-loc {
      font-size: 0.9em;
      color: #333;
      margin-left: 2em;
      font-family: 'Lora', serif;
    }

    .score-info {
      padding: 12px;
      margin-bottom: 20px;
      background-color: #eaf5fa;
      border: 1px solid #b3d9ff;
      border-left: 5px solid #79a9f2;
      border-radius: 5px;
      font-size: 0.95em;
      color: #333;
    }

    #scrollToTop {
      position: fixed;
      right: 20px;
      top: calc(20px + env(safe-area-inset-top, 0px));
      background-color: rgba(26, 115, 232, 0.95);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      z-index: 9999;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: transform 0.18s ease, opacity 0.18s ease;
      touch-action: manipulation;
    }

    /* helper classes: JS may toggle display or add the .show class */
    #scrollToTop.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    #scrollToTop.hidden {
      opacity: 0;
      transform: translateY(-8px);
      pointer-events: none;
    }

    #scrollToTop:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.28);
    }

    #scrollToTop:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* Alphabet floating bar (for list/notes pages) */
    #alpha-floating-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
      /* lift slightly so phone UI won't cover it */
      z-index: 9998;
      display: flex;
      gap: 8px;
      /* Add padding that respects the safe area */
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom, 0px));
      background: rgba(248, 249, 250, 0.95);
      /* Slightly less transparent */
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      /* Ensure it has a minimum height */
      min-height: 50px;
      align-items: center;
      /* Vertically center the links */
    }

    @media (max-width: 640px) {
      #alpha-floating-bar {
        bottom: calc(env(safe-area-inset-bottom, 0px) + 72px);
        /* keep above mobile browser toolbars */
        padding-bottom: 12px;
      }
    }

    #alpha-floating-bar a {
      display: inline-block;
      white-space: nowrap;
      padding: 6px 10px;
      border-radius: 6px;
      background: rgba(240, 240, 240, 0.9);
      color: var(--button-bg);
      text-decoration: none;
      font-weight: 600;
      margin-right: 6px;
    }

    #alpha-floating-bar a:active {
      transform: translateY(0);
    }
  </style>
  <style>
    :root {
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }


    /* index.html固有のスタイル */
    .big-label {
      font-size: 1.2em;
      margin-bottom: 15px;
      padding: 10px;
      border-left: 4px solid var(--button-bg);
      background: #fffacd;
      border-radius: 0 4px 4px 0;
      font-weight: 600;
      color: #1f2328;
    }

    .big-label-instruments {
      font-size: 1.2em;
      margin: 1.5em 0 15px;
      padding: 10px;
      border-left: 4px solid var(--button-bg);
      background: #fffacd;
      border-radius: 0 4px 4px 0;
      font-weight: 600;
      color: #1f2328;
    }

    #results {
      min-height: 200px;
      margin-bottom: 100px;
      /* フローティングバーとの重なりを回避 */
    }

    /* fieldsetのタイトル（legend）のスタイル */
    fieldset legend {
      display: block;
      /* 非表示設定を解除 */
      font-size: 1.1rem;
      font-weight: bold;
      padding: 0 10px;
      /* 左右に余白を追加 */
      margin-left: 10px;
      /* 左寄せ */
      color: var(--text-color);
    }

    /* --- アコーディオンのスタイル --- */
    .instrument-group {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 12px;
      background-color: #fafafa;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .instrument-group summary {
      font-size: 0.95rem;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
      outline: none;
      list-style: none;
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .instrument-group summary::-webkit-details-marker {
      display: none;
    }

    .instrument-group summary::before {
      content: '▶';
      margin-right: 8px;
      font-size: 0.75em;
      color: #666;
      transition: transform 0.2s ease;
    }

    .instrument-group[open]>summary {
      background: #e8f0fe;
      border-bottom: 1px solid #d2e3fc;
      border-radius: 6px 6px 0 0;
    }

    .instrument-group[open]>summary::before {
      transform: rotate(90deg);
      color: var(--button-bg);
    }

    .instrument-group fieldset {
      border: none;
      margin: 0;
      padding: 8px 12px;
      background: #fff;
      border-radius: 0 0 6px 6px;
    }

    /* --- ここまで --- */

    #works {
      background-color: #fceef1;
    }

    #conductor {
      background-color: #fcf7df;
    }

    #strings {
      background-color: #e7f5e7;
    }

    #woodwinds {
      background-color: #eaf5fa;
    }

    #brass {
      background-color: #fff9d9;
    }

    #percussions {
      background-color: #fef2e7;
    }

    #vocal {
      background-color: #fbeaf3;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 6px 12px;
    }

    @media (max-width: 500px) {
      .checkbox-grid {
        grid-template-columns: 1fr;
      }
    }

    .inner-checkbox-group {
      max-height: 200px;
      overflow-y: auto;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: Georgia, serif;
    }

    .checkbox-grid label {
      display: block;
      white-space: normal;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      font-family: Georgia, serif;
      background: #fff;
    }

    .checkbox-grid label:hover {
      background-color: #f8f9fa;
      border-color: #d0d7de;
    }

    .checkbox-grid label.checked {
      background-color: #e8f0fe;
      border-color: #d2e3fc;
      color: var(--button-bg);
    }

    .all-label {
      display: block;
      padding: 5px 8px;
      margin: 2px 0 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: #fff;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-weight: 600;
      color: #1f2328;
    }

    .all-label:hover {
      background-color: #f8f9fa;
      border-color: #d0d7de;
    }

    .all-label.checked {
      background-color: #e8f0fe;
      border-color: #d2e3fc;
      color: var(--button-bg);
    }

    label input[type="checkbox"] {
      margin-right: 10px;
    }

    .result-a {
      font-size: 1em;
      font-weight: bold;
      margin-top: 1em;
    }

    .result-c {
      font-size: 0.95em;
      margin-bottom: 4px;
      margin-left: 1em;
    }

    .result-loc {
      font-size: 0.9em;
      color: #333;
      margin-left: 2em;
    }

    .inner-checkbox-group::-webkit-scrollbar {
      width: 8px;
    }

    .inner-checkbox-group::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .inner-checkbox-group::-webkit-scrollbar-track {
      background-color: #ddd;
      border-radius: 4px;
    }

    .checkbox-grid-songs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }

    @media (max-width: 600px) {
      .checkbox-grid-songs {
        grid-template-columns: 1fr;
      }
    }

    .checkbox-grid-songs label {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.95rem;
      transition: background-color 0.2s ease;
    }

    .checkbox-grid-songs label.checked {
      background-color: rgba(200, 200, 200, 0.4);
    }

    /* --- フローティング検索バー --- */
    #floating-bar {
      position: fixed;
      bottom: calc(var(--safe-area-bottom) + 32px);
      left: 0;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.98);
      padding: 10px 15px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-wrap: nowrap;
      align-items: stretch;
      gap: 12px;
      z-index: 1000;
      font-weight: normal;
      color: #333;
      max-height: 24vh;
      min-height: 120px;
      overflow: hidden;
    }

    #floating-bar .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      flex: 0 0 auto;
    }

    #floating-bar button {
      font-weight: normal;
    }

    #floating-bar .button-group button {
      min-width: 110px;
    }

    #selection-summary {
      flex: 1 1 auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      word-break: break-word;
      font-family: Georgia, serif;
      font-size: 0.85em;
      text-align: left;
      align-items: flex-start;
      overflow-y: auto;
    }

    #selection-summary .summary-block {
      width: 100%;
    }

    #selection-summary .summary-title {
      font-weight: normal;
      text-align: left;
    }

    #selection-summary .summary-value {
      margin-top: 4px;
      text-align: left;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      #floating-bar {
        flex-direction: row;
        align-items: stretch;
        gap: 10px;
        max-height: 28vh;
      }

      #selection-summary {
        width: auto;
        max-height: 22vh;
      }

      #floating-bar .button-group {
        order: 0;
        flex-direction: column;
        justify-content: flex-start;
        flex-wrap: nowrap;
        gap: 8px;
        width: auto;
      }

      #floating-bar .button-group button {
        flex: 0 0 auto;
        min-width: 120px;
      }
    }
  </style>

  <script>
    /***********************************************************
     * このページのクライアントサイドスクリプト
     * 
     * - チェックボックスの「ALL」制御
     * - 楽器一括選択/解除
     * - 検索ボタン押下時にサーバー側 (mahler.js) の searchData() を呼び出し
     * - 結果を画面に表示
     ***********************************************************/
    // mahler.js から dMapping をコピー
    const dMapping = {
      "all": "ALLE", "dir": "Dirigent", "v1": "Violine1", "v2": "Violine2", "va": "Bratche", "vc": "Violoncello",
      "kb": "Kontrabaß", "sv": "Solo Violine", "sva": "Solo Bratche", "svc": "Solo Violoncello", "skb": "Solo Kontrabaß",
      "fl": "Flöte", "pic": "Piccolo", "ob": "Oboe", "eh": "Englischhorn", "cl": "Klarinette", "escl": "Es-Klarinette",
      "bcl": "Bassklarinette", "fg": "Fagott", "cfg": "Kontrafagott", "tr": "Trompete", "pis": "Piston",
      "phr": "Posthorn", "hr": "Horn", "thr": "Tenorhorn", "ohr": "Obligates Horn", "fhr": "Flügelhorn",
      "whr": "Waldhorn", "pos": "Posaune", "bt": "Basstuba", "pau": "Pauken", "gtr": "Gloße Trommel",
      "ktr": "Kleine Trommel", "mtr": "Militär Trommel", "bec": "Becken", "tam": "Tam-tam", "tri": "Triangel",
      "gls": "Glockenspiel", "hgl": "Herdenglocken", "gl": "Glocken", "ham": "Hammer", "rt": "Rute",
      "cel": "Celesta", "hp": "Harfe", "org": "Orgel", "klv": "Klavier", "har": "Harmonium", "git": "Gitarre",
      "man": "Mandoline", "sop": "Sopran", "alt": "Alto", "ten": "Tenor", "bar": "Bariton", "bass": "Bass",
      "sop1": "Sopran1", "sop2": "Sopran2", "alt1": "Alto1", "alt2": "Alto2", "kalt": "Knabe(Alto)",
      "chor": "Chor", "chor1": "Chor1", "chor2": "Chor2", "fchor": "frauen Chor", "kchor": "knaben Chor", "sti": "Stimme"
    };

    // 楽器群のALL選択時の表示名マッピング
    const groupAllDisplayMap = {
      'ALL_STRINGS': '弦楽器群',
      'ALL_WOODWINDS': '木管楽器群',
      'ALL_BRASS': '金管楽器群',
      'ALL_PERCUSSIONS': '打楽器群など',
      'ALL_VOCAL': '声楽・合唱'
    };

    window._allGlobalSelected = false;
    // 楽器「すべて選択」ボタンが押されたかどうかを判定するフラグ

    let currentSearchId = 0;
    // 検索キャンセル時に結果を無視するためのID

    window.addEventListener('DOMContentLoaded', () => {
      // 「すべての曲を選択」ボタン
      document.getElementById('all-works-button').addEventListener('click', e => {
        selectAllWorks();
      });

      // すべてのチェックボックスの初期状態に応じてラベル背景を付与
      const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      allCheckboxes.forEach(ch => {
        if (ch.checked) {
          ch.parentElement.classList.add('checked');
        }
        ch.addEventListener('click', e => {
          // クリックされた後にセット
          setTimeout(() => {
            if (ch.checked) {
              ch.parentElement.classList.add('checked');
            } else {
              ch.parentElement.classList.remove('checked');
            }
            updateSelectionSummary(); // サマリーを更新
          }, 0);
        });
      });

      // グループで「ALL」がチェックされたら他をOFFにし、外されたら全部外すなどの排他制御
      const groupIds = ['works', 'strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      groupIds.forEach(groupId => {
        const fieldset = document.getElementById(groupId);
        if (!fieldset) return;

        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(chk => {
          chk.addEventListener('click', e => {
            setTimeout(() => {
              window._allGlobalSelected = false;
              if (e.target.value.toLowerCase() === 'all') {
                // 「ALL」チェックがONになった場合は同じfieldset内の他をOFF
                if (e.target.checked) {
                  checkboxes.forEach(other => {
                    if (other !== e.target) {
                      other.checked = false;
                      other.parentElement.classList.remove('checked');
                    }
                  });
                } else {
                  // 「ALL」チェックが外れた場合は全体クリア
                  checkboxes.forEach(other => {
                    other.checked = false;
                    other.parentElement.classList.remove('checked');
                  });
                }
              } else {
                // 個別チェックがONになったら「ALL」はOFFに
                if (e.target.checked) {
                  const allBox = fieldset.querySelector('input[value="ALL"]');
                  if (allBox) {
                    allBox.checked = false;
                    allBox.parentElement.classList.remove('checked');
                  }
                }
              }
              updateSelectionSummary(); // サマリーを更新
            }, 0);
          });
        });
      });

      // 各箇所の「ALL」チェックボックスに個別イベント
      document.getElementById('all-works').addEventListener('click', e => {
        const allWorksCheckbox = e.target;
        const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]:not(#all-works)');
        if (allWorksCheckbox.checked) {
          // ONの場合は他をすべてOFFに
          workCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-strings').addEventListener('click', e => {
        const allStringsCheckbox = e.target;
        const stringCheckboxes = document.querySelectorAll('#strings input[type="checkbox"]:not(#all-strings)');
        if (allStringsCheckbox.checked) {
          stringCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-woodwinds').addEventListener('click', e => {
        const allWoodwindsCheckbox = e.target;
        const woodwindsCheckboxes = document.querySelectorAll('#woodwinds input[type="checkbox"]:not(#all-woodwinds)');
        if (allWoodwindsCheckbox.checked) {
          woodwindsCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-brass').addEventListener('click', e => {
        const allBrassCheckbox = e.target;
        const brassCheckboxes = document.querySelectorAll('#brass input[type="checkbox"]:not(#all-brass)');
        if (allBrassCheckbox.checked) {
          brassCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-percussions').addEventListener('click', e => {
        const allPercussionsCheckbox = e.target;
        const percussionsCheckboxes = document.querySelectorAll('#percussions input[type="checkbox"]:not(#all-percussions)');
        if (allPercussionsCheckbox.checked) {
          percussionsCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-vocal').addEventListener('click', e => {
        const allVocalCheckbox = e.target;
        const vocalCheckboxes = document.querySelectorAll('#vocal input[type="checkbox"]:not(#all-vocal)');
        if (allVocalCheckbox.checked) {
          vocalCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      // 「すべての楽器を選択」ボタン
      document.getElementById('all-instruments').addEventListener('click', e => {
        selectAllInAllGroups();
      });

      // 「楽器をクリア」ボタン
      document.getElementById('clear-instruments').addEventListener('click', e => {
        deselectAllInAllGroups();
      });

      updateSelectionSummary(); // 初期表示
    });

    /**
     * 全楽器群 + 指揮者 = ALL扱い
     * 一括で全部をチェックONにする
     */
    function selectAllInAllGroups() {
      // 一旦全部外してから
      deselectAllInAllGroups();
      const instrumentGroupIds = ['strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      instrumentGroupIds.forEach(id => {
        const fieldset = document.getElementById(id);
        if (!fieldset) return;
        const allBox = fieldset.querySelector('input[value="ALL"]');
        if (allBox) {
          allBox.checked = true;
          allBox.parentElement.classList.add('checked');
        }
      });
      // 指揮者チェック
      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox) {
        conductorCheckbox.checked = true;
        conductorCheckbox.parentElement.classList.add('checked');
      }
      // 開いていることが分かるように、楽器のinstrument-groupアコーディオンを開く
      document.querySelectorAll('.instrument-group:not(#works-group)').forEach(d => { d.open = true; });
      window._allGlobalSelected = true;
      updateSelectionSummary();
    }

    /**
     * すべての楽器・指揮者のチェックを外す
     */
    function deselectAllInAllGroups() {
      const instrumentGroupIds = ['strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      instrumentGroupIds.forEach(id => {
        const fieldset = document.getElementById(id);
        if (!fieldset) return;
        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(chk => {
          chk.checked = false;
          chk.parentElement.classList.remove('checked');
        });
      });
      // 指揮者も外す
      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox) {
        conductorCheckbox.checked = false;
        conductorCheckbox.parentElement.classList.remove('checked');
      }
      // 楽器の instrument-group アコーディオンを閉じる
      document.querySelectorAll('.instrument-group:not(#works-group)').forEach(d => { d.open = false; });
      window._allGlobalSelected = false;
      updateSelectionSummary();
    }

    /**
     * 「検索」ボタン押下時に呼ばれる
     * - ユーザ選択の曲名 / 楽器群 を取得
     * - サーバー側の searchData() を実行
     * - 結果を #results に表示
     */
    function search() {
      const searchButton = document.querySelector('#floating-bar .btn-action');
      const resultsDiv = document.getElementById('results');
      const loadingHtml = '<p class=\"loading\">検索中・・・</p>';
      resultsDiv.innerHTML = loadingHtml;
      focusResultsPanel({ instant: true });

      // 曲名と楽器の選択状態を取得
      const works = getSelectedWorks();
      const instruments = getSelectedInstruments();
      // ラジオボタン「オーケストラ全体を含める」かどうか
      const includeOrchestraAll = document.querySelector('input[name=\"include-orchestra-all\"]:checked').value === 'on';

      // 未選択チェック
      if (works.length === 0) {
        resultsDiv.innerHTML = '<p class=\"loading\">曲名を選択してください。</p>';
        searchButton.disabled = false;
        focusResultsPanel({ instant: true });
        return;
      }
      if (!includeOrchestraAll && instruments.length === 0) {
        resultsDiv.innerHTML = '<p class=\"loading\">楽器を選択してください。</p>';
        searchButton.disabled = false;
        focusResultsPanel({ instant: true });
        return;
      }

      // 検索ボタンを無効化し、色を薄くする
      searchButton.disabled = true;
      // 検索IDを更新（キャンセル制御用）
      currentSearchId++;
      const thisSearchId = currentSearchId;

      // Local static app: Call searchMahlerData directly
      setTimeout(() => {
        try {
          const html = searchMahlerData(works, instruments, includeOrchestraAll);
          if (thisSearchId === currentSearchId) {
            resultsDiv.innerHTML = html;
            focusResultsPanel({ instant: true });
            searchButton.disabled = false;
          }
        } catch (e) {
          console.error(e);
          if (thisSearchId === currentSearchId) {
            resultsDiv.innerHTML = `<p class="result-message">エラーが発生しました: ${e.message}</p>`;
            searchButton.disabled = false;
          }
        }
      }, 10);
    }

    /**
     * 「中止」ボタン押下時
     * - currentSearchId を更新して、既存の検索結果を無効化
     */
    function cancelSearch() {
      const searchButton = document.querySelector('#floating-bar .btn-action');
      const resultsDiv = document.getElementById('results');
      if (resultsDiv) {
        resultsDiv.innerHTML = '<p class="loading">検索を中止しました。</p>';
        focusResultsPanel({ instant: true });
      }
      currentSearchId++;
      // 中止した場合もボタンを有効に戻す
      searchButton.disabled = false;
    }

    /**
     * 楽器の選択状態を取得し、配列で返す
     */
    function getSelectedInstruments() {
      let selected = [];
      // フィールドセットIDと、それが表す「ALL_xxx」
      const groupMappings = {
        'strings': 'ALL_STRINGS',
        'woodwinds': 'ALL_WOODWINDS',
        'brass': 'ALL_BRASS',
        'percussions': 'ALL_PERCUSSIONS',
        'vocal': 'ALL_VOCAL'
      };

      // 各フィールドセットごとにチェックボックス状態を確認
      for (const [groupId, allValue] of Object.entries(groupMappings)) {
        const fieldset = document.getElementById(groupId);
        if (!fieldset) continue;
        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');

        let allChecked = false;
        let normalValues = [];
        checkboxes.forEach(chk => {
          if (chk.value.toLowerCase() === 'all') {
            // ALL チェックボックス
            if (chk.checked) allChecked = true;
          } else {
            // 個別楽器
            if (chk.checked) normalValues.push(chk.value.toLowerCase());
          }
        });

        // もし ALL がONなら、ALL_STRINGS などのキーを selected に追加
        if (allChecked) {
          selected.push(allValue);
        } else {
          // そうでなければ個別の楽器コードを追加
          selected.push(...normalValues);
        }
      }

      // 指揮者がチェックされていたら追加
      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox && conductorCheckbox.checked) {
        selected.push('dir');
      }

      // 全部の楽器を一括選択したフラグがONなら 'ALL_GLOBAL' を追加
      if (window._allGlobalSelected) {
        selected.push('ALL_GLOBAL');
      }

      return selected;
    }

    /**
     * 曲名の選択状態を取得し、配列で返す
     */
    function getSelectedWorks() {
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]');
      const selected = Array.from(workCheckboxes)
        .filter(chk => chk.checked)
        .map(chk => chk.value.toLowerCase());

      // ALL が含まれていれば ['ALL'] として返す
      return selected.includes('all') ? ['ALL'] : selected;
    }

    /**
     * 曲名をすべて選択
     */
    function selectAllWorks() {
      // 曲名のアコーディオンを開く
      const worksDetails = document.getElementById('works-group');
      if (worksDetails) worksDetails.open = true;

      // 「ALL」チェックボックスをONにする
      const allWorksCheckbox = document.getElementById('all-works');
      if (allWorksCheckbox) {
        allWorksCheckbox.checked = true;
        allWorksCheckbox.parentElement.classList.add('checked');
      }

      // 他の曲名チェックボックスをOFFにする
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]:not(#all-works)');
      workCheckboxes.forEach(chk => {
        chk.checked = false;
        chk.parentElement.classList.remove('checked');
      });

      updateSelectionSummary();
    }

    /**
     * 曲名をクリア
     */
    function clearWorks() {
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]');
      workCheckboxes.forEach(chk => {
        chk.checked = false;
        chk.parentElement.classList.remove('checked');
      });
      // 曲名のアコーディオン（works-group）を閉じる
      const worksDetails = document.getElementById('works-group');
      if (worksDetails) worksDetails.open = false;
      updateSelectionSummary();
    }

    /**
     * 選択状況のサマリーを更新する
     */
    function updateSelectionSummary() {
      const summaryDiv = document.getElementById('selection-summary');
      if (!summaryDiv) return;

      const selectedWorks = getSelectedWorks();
      const selectedInstruments = getSelectedInstruments();

      const workLabelMap = {};
      document.querySelectorAll('#works input[type="checkbox"]').forEach(chk => {
        const key = chk.value.toLowerCase();
        const labelText = chk.parentElement ? chk.parentElement.textContent.trim() : chk.value;
        workLabelMap[key] = labelText;
      });

      let workValue = 'なし';
      if (selectedWorks.length > 0) {
        if (selectedWorks[0] === 'ALL') {
          workValue = 'すべて';
        } else {
          const workNames = selectedWorks.map(code => workLabelMap[code] || code);
          if (workNames.length > 0) {
            workValue = workNames.join('<br>');
          }
        }
      }

      let instrumentValue = 'なし';
      if (selectedInstruments.length > 0) {
        if (selectedInstruments.includes('ALL_GLOBAL')) {
          instrumentValue = 'すべて';
        } else {
          const instrumentNames = selectedInstruments
            .map(code => groupAllDisplayMap[code] || dMapping[code.toLowerCase()] || code)
            .filter(name => name && name !== 'ALL_GLOBAL');
          if (instrumentNames.length > 0) {
            instrumentValue = instrumentNames.join('<br>');
          }
        }
      }

      summaryDiv.innerHTML =
        '<div class="summary-block">' +
        '<div class="summary-title">選択した曲：</div>' +
        '<div class="summary-value">' + workValue + '</div>' +
        '</div>' +
        '<div class="summary-block">' +
        '<div class="summary-title">選択した楽器：</div>' +
        '<div class="summary-value">' + instrumentValue + '</div>' +
        '</div>';

      adjustFloatingBarSpacing();
    }

    function adjustFloatingBarSpacing() {
      const floatingBar = document.getElementById('floating-bar');
      const container = document.querySelector('.container');
      if (!floatingBar || !container) return;

      const barHeight = floatingBar.offsetHeight;
      const safeArea = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-bottom')) || 0;
      const offset = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--floating-bar-offset')) || 0;
      container.style.paddingBottom = (barHeight + 40 + safeArea + offset) + 'px';
    }

    function updateFloatingBarOffset() {
      let offset = 16;
      if (window.visualViewport) {
        const diff = window.innerHeight - window.visualViewport.height;
        if (diff > 0) offset += diff;
      }
      document.documentElement.style.setProperty('--floating-bar-offset', `${offset}px`);
      adjustFloatingBarSpacing();
    }



    window.addEventListener('resize', updateFloatingBarOffset);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateFloatingBarOffset);
      window.visualViewport.addEventListener('scroll', updateFloatingBarOffset);
    }
  </script>

</head>

<body>
  <div class="container">
    <h1>曲名と楽器から検索 (GM)</h1>
    <p><b>用語集は<a href="https://sites.google.com/site/brucknermahleryinleyongyu/%E7%94%A8%E8%AA%9E%E9%9B%86"
          target="_blank">こちら</a></b></p>
    <!-- 曲名エリア -->
    <div class="big-label">
      曲名を選択
    </div>
    <div style="margin-bottom: 15px;">
      <button type="button" id="all-works-button" class="btn-action">すべての曲を選択</button>
      <button type="button" onclick="clearWorks()" class="btn-clear">曲名をクリア</button>
    </div>
    <!-- 曲名をアコーディオン化: instrument-group の挙動に合わせる -->
    <details class="instrument-group" id="works-group">
      <summary>曲名</summary>
      <fieldset id="works">
        <!-- ALLチェックボックス -->
        <label class="all-label">
          <input type="checkbox" id="all-works" value="ALL">ALL
        </label>
        <div class="inner-checkbox-group checkbox-grid-songs">
          <!-- 曲名チェックボックス群 -->
          <label><input type="checkbox" value="交響曲第1番ニ長調（1884-88）">交響曲第1番ニ長調（1884-88）</label>
          <label><input type="checkbox" value="交響曲第2番ハ短調（1888-94）">交響曲第2番ハ短調（1888-94）</label>
          <label><input type="checkbox" value="交響曲第3番ニ短調（1893-96）">交響曲第3番ニ短調（1893-96）</label>
          <label><input type="checkbox" value="交響曲第4番ト長調（1899-1900）">交響曲第4番ト長調（1899-1900）</label>
          <label><input type="checkbox" value="交響曲第5番嬰ハ短調（1901-02）">交響曲第5番嬰ハ短調（1901-02）</label>
          <label><input type="checkbox" value="交響曲第6番イ短調（1903-04）">交響曲第6番イ短調（1903-04）</label>
          <label><input type="checkbox" value="交響曲第7番ホ短調（1904-05）">交響曲第7番ホ短調（1904-05）</label>
          <label><input type="checkbox" value="交響曲第8番変ホ長調（1906）">交響曲第8番変ホ長調（1906）</label>
          <label><input type="checkbox" value="交響曲イ短調『大地の歌』（1908）">交響曲イ短調『大地の歌』（1908）</label>
          <label><input type="checkbox" value="交響曲第9番ニ長調（1909）">交響曲第9番ニ長調（1909）</label>
          <label><input type="checkbox" value="交響曲第10番嬰ヘ長調（1910）">交響曲第10番嬰ヘ長調（1910）</label>
          <label><input type="checkbox" value="交響曲第10番（クック版）">交響曲第10番（クック版）</label>
          <label><input type="checkbox" value="嘆きの歌（1880）">嘆きの歌（1880）</label>
          <label><input type="checkbox" value="嘆きの歌（1899）">嘆きの歌（1899）</label>
          <label><input type="checkbox" value="さすらう若人の歌">さすらう若人の歌</label>
          <label><input type="checkbox" value="子供の魔法の角笛">子供の魔法の角笛</label>
          <label><input type="checkbox" value="子供の死の歌">子供の死の歌</label>
          <label><input type="checkbox" value="リュッケルトの詩による5つの歌">リュッケルトの詩による5つの歌</label>
          <label><input type="checkbox" value="花の章">花の章</label>
          <label><input type="checkbox" value="葬礼">葬礼</label>
        </div>
      </fieldset>
    </details>

    <!-- 楽器選択エリア -->
    <div class="big-label-instruments">
      楽器を選択
    </div>
    <div style="margin-bottom: 15px;">
      <button type="button" id="all-instruments" class="btn-action">すべての楽器を選択</button>
      <button type="button" id="clear-instruments" class="btn-clear">楽器をクリア</button>
      <div style="margin-top: 10px;">
        <!-- オーケストラ全体を含めるかどうかのラジオボタン -->
        <label style="display: block; margin-bottom: 5px;">
          <input type="radio" name="include-orchestra-all" value="on" checked>
          オーケストラ全体への指示を含める
        </label>
        <label style="display: block; margin-bottom: 15px;">
          <input type="radio" name="include-orchestra-all" value="off">
          含めない
        </label>
      </div>
    </div>

    <!-- 指揮者 -->
    <details class="instrument-group">
      <summary>指揮者</summary>
      <fieldset id="conductor">
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="dir">Dirigent</label>
        </div>
      </fieldset>
    </details>

    <!-- 弦楽器群 -->
    <details class="instrument-group">
      <summary>弦楽器群</summary>
      <fieldset id="strings">
        <label class="all-label"><input type="checkbox" id="all-strings" value="ALL">ALL</label>
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="v1">Violine1</label>
          <label><input type="checkbox" value="v2">Violine2</label>
          <label><input type="checkbox" value="va">Bratche</label>
          <label><input type="checkbox" value="vc">Violoncello</label>
          <label><input type="checkbox" value="kb">Kontrabaß</label>
          <label><input type="checkbox" value="sv">Solo Violine</label>
          <label><input type="checkbox" value="sva">Solo Bratche</label>
          <label><input type="checkbox" value="svc">Solo Violoncello</label>
          <label><input type="checkbox" value="skb">Solo Kontrabaß</label>
        </div>
      </fieldset>
    </details>

    <!-- 木管楽器群 -->
    <details class="instrument-group">
      <summary>木管楽器群</summary>
      <fieldset id="woodwinds">
        <label class="all-label"><input type="checkbox" id="all-woodwinds" value="ALL">ALL</label>
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="fl">Flöte</label>
          <label><input type="checkbox" value="pic">Piccolo</label>
          <label><input type="checkbox" value="ob">Oboe</label>
          <label><input type="checkbox" value="eh">Englischhorn</label>
          <label><input type="checkbox" value="cl">Klarinette</label>
          <label><input type="checkbox" value="escl">Es-Klarinette</label>
          <label><input type="checkbox" value="bcl">Bassklarinette</label>
          <label><input type="checkbox" value="fg">Fagott</label>
        </div>
      </fieldset>
    </details>

    <!-- 金管楽器群 -->
    <details class="instrument-group">
      <summary>金管楽器群</summary>
      <fieldset id="brass">
        <label class="all-label"><input type="checkbox" id="all-brass" value="ALL">ALL</label>
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="tr">Trompete</label>
          <label><input type="checkbox" value="pis">Piston</label>
          <label><input type="checkbox" value="phr">Posthorn</label>
          <label><input type="checkbox" value="hr">Horn</label>
          <label><input type="checkbox" value="thr">Tenorhorn</label>
          <label><input type="checkbox" value="ohr">Obligates Horn</label>
          <label><input type="checkbox" value="fhr">Flügelhorn</label>
          <label><input type="checkbox" value="whr">Waldhorn</label>
          <label><input type="checkbox" value="pos">Posaune</label>
          <label><input type="checkbox" value="bt">Basstuba</label>
        </div>
      </fieldset>
    </details>

    <!-- 打楽器群 -->
    <details class="instrument-group">
      <summary>打楽器群など</summary>
      <fieldset id="percussions">
        <label class="all-label"><input type="checkbox" id="all-percussions" value="ALL">ALL</label>
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="pau">Pauken</label>
          <label><input type="checkbox" value="gtr">Gloße Trommel</label>
          <label><input type="checkbox" value="ktr">Kleine Trommel</label>
          <label><input type="checkbox" value="mtr">Militär Trommel</label>
          <label><input type="checkbox" value="bec">Becken</label>
          <label><input type="checkbox" value="tam">Tam-tam</label>
          <label><input type="checkbox" value="tri">Triangel</label>
          <label><input type="checkbox" value="gls">Glockenspiel</label>
          <label><input type="checkbox" value="hgl">Herdenglocken</label>
          <label><input type="checkbox" value="gl">Glocken</label>
          <label><input type="checkbox" value="ham">Hammer</label>
          <label><input type="checkbox" value="rt">Rute</label>
          <label><input type="checkbox" value="cel">Celesta</label>
          <label><input type="checkbox" value="hp">Harfe</label>
          <label><input type="checkbox" value="org">Orgel</label>
          <label><input type="checkbox" value="klv">Klavier</label>
          <label><input type="checkbox" value="har">Harmonium</label>
          <label><input type="checkbox" value="git">Gitarre</label>
          <label><input type="checkbox" value="man">Mandoline</label>
        </div>
      </fieldset>
    </details>

    <!-- 声楽・合唱 -->
    <details class="instrument-group">
      <summary>声楽・合唱</summary>
      <fieldset id="vocal">
        <label class="all-label"><input type="checkbox" id="all-vocal" value="ALL">ALL</label>
        <div class="inner-checkbox-group checkbox-grid">
          <label><input type="checkbox" value="sop">Sopran</label>
          <label><input type="checkbox" value="alt">Alto</label>
          <label><input type="checkbox" value="ten">Tenor</label>
          <label><input type="checkbox" value="bar">Bariton</label>
          <label><input type="checkbox" value="bass">Bass</label>
          <label><input type="checkbox" value="sop1">Sopran1</label>
          <label><input type="checkbox" value="sop2">Sopran2</label>
          <label><input type="checkbox" value="alt1">Alto1</label>
          <label><input type="checkbox" value="alt2">Alto2</label>
          <label><input type="checkbox" value="kalt">Knabe(Alto)</label>
          <label><input type="checkbox" value="chor">Chor</label>
          <label><input type="checkbox" value="chor1">Chor1</label>
          <label><input type="checkbox" value="chor2">Chor2</label>
          <label><input type="checkbox" value="fchor">frauen Chor</label>
          <label><input type="checkbox" value="kchor">knaben Chor</label>
          <label><input type="checkbox" value="sti">Stimme</label>
        </div>
      </fieldset>
    </details>

    <!-- 検索結果表示領域 -->
    <div id="results"></div>
  </div>

  <!-- フローティング検索バー -->
  <div id="floating-bar">
    <div id="selection-summary"></div>
    <div class="button-group">
      <button type="button" onclick="search()" class="btn-action">検索</button>
      <button type="button" onclick="cancelSearch()" class="btn-danger">中止</button>
    </div>
  </div>

  <!-- ページのトップへ戻るボタン -->
  <div id="scrollToTop" onclick="scrollToTop()">▲ ページのトップへ戻る</div>
  <script>
    /*
     * common_scripts.html
     * 全ページで共通して使用されるクライアントサイドJavaScript。
     * 主に「トップへ戻る」ボタンの制御など、UIの基本的な動作を定義します。
     */
    // Client-only helpers and UI glue. Guard against server (Apps Script) context.
    (function () {
      if (typeof window === 'undefined' || typeof document === 'undefined') {
        // Define no-op globals so server-side references do not throw
        this.scrollToTop = function () { };
        this.setResults = function () { };
        return;
      }

      // Helper: Throttle function to limit event firing frequency
      function throttle(func, limit) {
        let inThrottle;
        return function () {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        }
      }

      // Show/hide the "back to top" button — use class toggles and run on load/resize/scroll
      // Throttled to avoid freezing on heavy pages
      let isScrolling = false;
      function updateScrollToTopVisibility() {
        const scrollToTopBtn = document.getElementById('scrollToTop');
        if (!scrollToTopBtn) {
          isScrolling = false; // ensure flag is reset even if btn missing
          return;
        }
        // show when scrolled down a bit
        if (window.scrollY > 300) {
          scrollToTopBtn.classList.add('show');
          scrollToTopBtn.classList.remove('hidden');
        } else {
          scrollToTopBtn.classList.remove('show');
          scrollToTopBtn.classList.add('hidden');
        }
        isScrolling = false;
      }

      function onScrollThrottled() {
        if (!isScrolling) {
          window.requestAnimationFrame(updateScrollToTopVisibility);
          isScrolling = true;
        }
      }

      window.addEventListener('scroll', onScrollThrottled, { passive: true });

      // Throttled resize handler for scroll-to-top visibility
      const throttledUpdateVisibility = throttle(updateScrollToTopVisibility, 200);
      window.addEventListener('resize', throttledUpdateVisibility);
      window.addEventListener('orientationchange', () => setTimeout(updateScrollToTopVisibility, 160));

      // ensure initial state after load (some mobile browsers change viewport after load)
      window.addEventListener('load', () => {
        updateScrollToTopVisibility();
        // second check shortly after to account for browser UI show/hide
        setTimeout(updateScrollToTopVisibility, 300);
      });

      // Expose global helpers
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      window.scrollToTop = scrollToTop;

      function focusResultsPanel(options) {
        const resultsDiv = document.getElementById('results');
        if (!resultsDiv) return;

        const topOffset = Math.max((resultsDiv.getBoundingClientRect().top + window.scrollY) - 20, 0);
        const behavior = options && options.instant ? 'auto' : 'smooth';
        window.scrollTo({ top: topOffset, behavior });
      }
      window.focusResultsPanel = focusResultsPanel;

      function setResults(html) {
        const resultsDiv = document.getElementById('results');
        if (!resultsDiv) return;
        resultsDiv.innerHTML = html;
        focusResultsPanel({ instant: true });
      }
      window.setResults = setResults;

      // Fix garbled static texts for Wagner/Strauss pages
      document.addEventListener('DOMContentLoaded', () => {
        const isComposerPage = /Richard Wagner|Richard Strauss/.test(document.title);
        if (!isComposerPage) return;

        const firstP = document.querySelector('.container > p');
        if (firstP) firstP.textContent = 'オーケストラに対する指示で GM の検索ページで何とかなりそうなものは基本的に不記載';

        const bigLabels = document.querySelectorAll('.big-label');
        if (bigLabels && bigLabels[0]) bigLabels[0].textContent = '曲を選択';

        const smc = document.getElementById('search-method-container');
        if (smc) {
          const bl = smc.querySelector('.big-label');
          if (bl) bl.textContent = '検索方法を選択';
          const legend = smc.querySelector('legend');
          if (legend) legend.textContent = '方法';
          const labels = smc.querySelectorAll('label');
          labels.forEach(label => {
            const input = label.querySelector('input[type="radio"]');
            if (!input) return;
            if (input.value === 'scene') label.lastChild.textContent = ' 場面から選択';
            if (input.value === 'page') label.lastChild.textContent = ' ページから選択';
          });
        }

        const psc = document.getElementById('page-selection-container');
        if (psc) {
          const legend2 = psc.querySelector('legend');
          if (legend2) legend2.textContent = 'ページ番号';
          const note = psc.querySelector('p');
          if (note) note.textContent = 'ページ番号を半角で入力';
          const input = document.getElementById('page-input');
          if (input) input.setAttribute('placeholder', '例 3,14,15-92');
        }

        const topBtn = document.getElementById('scrollToTop');
        if (topBtn) topBtn.textContent = '▲ ページのトップへ戻る';
      });

      // Create an alphabet floating bar for pages that have #navbar (notes/list)
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const nav = document.getElementById('navbar');
          if (!nav) return;
          // Do not interfere with pages that already have a floating search bar
          if (document.getElementById('floating-bar')) return;
          // If alpha-floating-bar already exists in DOM (we may have added it server-side),
          // still run spacing adjustment.
          if (!document.getElementById('alpha-floating-bar')) {
            const alphaBar = document.createElement('div');
            alphaBar.id = 'alpha-floating-bar';
            // copy only link nodes to avoid other elements
            alphaBar.innerHTML = Array.from(nav.querySelectorAll('a')).map(a => a.outerHTML).join(' ');
            document.body.appendChild(alphaBar);
          }

          function adjustAlphaBarSpacing() {
            const bar = document.getElementById('alpha-floating-bar');
            const container = document.querySelector('.container');
            if (!bar || !container) return;
            // ensure bar is visible
            bar.style.display = 'flex';
            const barHeight = bar.offsetHeight || 56;
            container.style.paddingBottom = (barHeight + 24) + 'px';
          }

          // Throttled resize handler for alpha bar spacing
          const throttledAdjustSpacing = throttle(adjustAlphaBarSpacing, 200);
          window.addEventListener('resize', throttledAdjustSpacing);
          window.addEventListener('orientationchange', () => setTimeout(adjustAlphaBarSpacing, 120));

          // Run adjustment on load and shortly after to handle mobile viewport changes
          setTimeout(adjustAlphaBarSpacing, 50);
          setTimeout(adjustAlphaBarSpacing, 300);
        } catch (e) {
          console.error('alpha-floating-bar init failed', e);
        }
      });
    })();
  </script>
<script src="js/app.js"></script>
</body>

</html>