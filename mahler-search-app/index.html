<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- Google Search Console Verification -->
  <meta name="google-site-verification" content="oMTfhSgc1nOrF9dVnBCR_YGcwCDYlrqNmyYn-UJuBJc" />
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZT6MPW5MNG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-ZT6MPW5MNG');
  </script>
  <meta charset="UTF-8">
  <link rel="canonical" href="https://yutaka-okawachi.github.io/gaswebapp-manual/mahler-search-app/index.html">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gustav Mahlerï¼ˆãƒãƒ¼ãƒ©ãƒ¼ï¼‰ã®äº¤éŸ¿æ›²ãªã©ã€ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ä½œå“ã«ãŠã‘ã‚‹æ¥½å™¨ç·¨æˆã‚„è©³ç´°ãªä½¿ç”¨ç®‡æ‰€ã‚’æ¤œç´¢ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚">
  <title>æ›²åã¨æ¥½å™¨ã‹ã‚‰æ¤œç´¢</title>
  <link rel="icon" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <link rel="stylesheet" href="css/common.css">
  <!-- Google Fonts æœ€é©åŒ– -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bitter:wght@700&family=Lora:wght@400;700&display=swap&subset=latin,latin-ext">
  <link href="https://fonts.googleapis.com/css2?family=Bitter:wght@700&family=Lora:wght@400;700&display=swap&subset=latin,latin-ext" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Bitter:wght@700&family=Lora:wght@400;700&display=swap&subset=latin,latin-ext" rel="stylesheet"></noscript>
  <script src="js/app.js" defer></script>
  <style>
    /* index.htmlå›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */

    :root {
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --floating-bar-offset: 0px;
    }

    .big-label {
      font-size: 1.2em;
      margin-bottom: 15px;
      padding: 10px;
      border-left: 4px solid var(--button-bg);
      background: #fffacd;
      border-radius: 0 4px 4px 0;
      font-weight: 600;
      color: #1f2328;
    }

    .big-label-instruments {
      font-size: 1.2em;
      margin: 1.5em 0 15px;
      padding: 10px;
      border-left: 4px solid var(--button-bg);
      background: #fffacd;
      border-radius: 0 4px 4px 0;
      font-weight: 600;
      color: #1f2328;
    }

    #results {
      min-height: 200px;
      margin-bottom: 100px;
      font-family: 'Lora', serif;
    }

    /* fieldsetã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆlegendï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    fieldset legend {
      display: block;
      font-size: 1.1rem;
      font-weight: bold;
      padding: 0 10px;
      margin-left: 10px;
      color: var(--text-color);
    }

    /* --- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .instrument-group {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 12px;
      background-color: #fafafa;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .instrument-group summary {
      font-size: 0.95rem;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
      outline: none;
      list-style: none;
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .instrument-group summary::-webkit-details-marker {
      display: none;
    }

    .instrument-group summary::before {
      content: 'â–¶';
      margin-right: 8px;
      font-size: 0.75em;
      color: #666;
      transition: transform 0.2s ease;
    }

    .instrument-group[open]>summary {
      background: #e8f0fe;
      border-bottom: 1px solid #d2e3fc;
      border-radius: 6px 6px 0 0;
    }

    .instrument-group[open]>summary::before {
      transform: rotate(90deg);
      color: var(--button-bg);
    }

    .instrument-group fieldset {
      border: none;
      margin: 0;
      padding: 8px 12px;
      background: #fff;
      border-radius: 0 0 6px 6px;
    }

    #works { background-color: #fceef1; }
    #conductor { background-color: #fcf7df; }
    #strings { background-color: #e7f5e7; }
    #woodwinds { background-color: #eaf5fa; }
    #brass { background-color: #fff9d9; }
    #percussions { background-color: #fef2e7; }
    #vocal { background-color: #fbeaf3; }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 6px 12px;
    }

    @media (max-width: 500px) {
      .checkbox-grid {
        grid-template-columns: 1fr;
      }
    }

    .inner-checkbox-group {
      max-height: 200px;
      overflow-y: auto;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: Georgia, serif;
    }

    .checkbox-grid label {
      display: block;
      white-space: normal;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      font-family: Georgia, serif;
      background: #fff;
    }

    .checkbox-grid label:hover {
      background-color: #f8f9fa;
      border-color: #d0d7de;
    }

    .checkbox-grid label.checked {
      background-color: #e8f0fe;
      border-color: #d2e3fc;
      color: var(--button-bg);
    }

    .all-label {
      display: block;
      padding: 5px 8px;
      margin: 2px 0 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: #fff;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-weight: 600;
      color: #1f2328;
    }

    .all-label:hover {
      background-color: #f8f9fa;
      border-color: #d0d7de;
    }

    .all-label.checked {
      background-color: #e8f0fe;
      border-color: #d2e3fc;
      color: var(--button-bg);
      margin-top: 0.5em;
      font-family: 'Lora', serif;
    }



    label input[type="checkbox"] {
      margin-right: 10px;
    }

    .result-entry {
      display: block; /* Override common.css flex */
      margin-bottom: 0.5em; /* Reduced spacing */
    }

    .result-a {
      font-size: 1.0rem; /* Unified size across all pages */
      font-weight: bold;

      font-family: 'Lora', serif;
    }

    .result-c {
      font-size: 0.85rem;
      font-weight: normal; /* Explicitly not bold */
      margin-bottom: 4px;
      margin-left: 1.5em; /* Increased indentation */
      font-family: 'Lora', serif;
    }

    .result-loc {
      font-size: 0.75rem;
      font-weight: normal; /* Explicitly not bold */
      color: #333;
      margin-left: 3em; /* Further increased indentation */
      font-family: 'Lora', serif;
    }

    .inner-checkbox-group::-webkit-scrollbar {
      width: 8px;
    }

    .inner-checkbox-group::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .inner-checkbox-group::-webkit-scrollbar-track {
      background-color: #ddd;
      border-radius: 4px;
    }

    .checkbox-grid-songs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }

    @media (max-width: 600px) {
      .checkbox-grid-songs {
        grid-template-columns: 1fr;
      }
    }

    .checkbox-grid-songs label {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.95rem;
      transition: background-color 0.2s ease;
    }

    .checkbox-grid-songs label.checked {
      background-color: rgba(200, 200, 200, 0.4);
    }

    /* --- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¤œç´¢ãƒãƒ¼ --- */
    #floating-bar {
      position: fixed;
      bottom: calc(var(--safe-area-bottom) + var(--floating-bar-offset));
      left: 0;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.98);
      padding: 10px 15px calc(10px + var(--safe-area-bottom)) 15px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-wrap: nowrap;
      align-items: stretch;
      gap: 12px;
      z-index: 1000;
      font-weight: normal;
      color: #333;
      max-height: 24vh;
      min-height: 120px;
      overflow: hidden;
    }

    #floating-bar .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      flex: 0 0 auto;
    }

    #floating-bar button {
      font-weight: normal;
    }

    #floating-bar .button-group button {
      min-width: 110px;
    }

    #selection-summary {
      flex: 1 1 auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      word-break: break-word;
      font-family: Georgia, serif;
      font-size: 0.8em;
      text-align: left;
      align-items: flex-start;
      overflow-y: auto;
    }

    #selection-summary .summary-block {
      width: 100%;
    }

    #selection-summary .summary-title {
      font-weight: normal;
      text-align: left;
      font-size: 0.9em;
    }

    #selection-summary .summary-value {
      margin-top: 4px;
      text-align: left;
      line-height: 1.5;
    }

    @media (max-width: 600px) {
      #floating-bar {
        flex-direction: row;
        align-items: stretch;
        gap: 10px;
        max-height: 28vh;
      }

      #selection-summary {
        width: auto;
        max-height: 22vh;
      }

      #floating-bar .button-group {
        order: 0;
        flex-direction: column;
        justify-content: flex-start;
        flex-wrap: nowrap;
        gap: 8px;
        width: auto;
      }

      #floating-bar .button-group button {
        flex: 0 0 auto;
        min-width: 120px;
      }
    }
  </style>

  <script>
    /***********************************************************
     * ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
     ***********************************************************/
    // mahler.js ã‹ã‚‰ dMapping ã‚’ã‚³ãƒ”ãƒ¼
    const dMapping = {
      "all": "ALLE", "dir": "Dirigent", "v1": "Violine1", "v2": "Violine2", "va": "Bratsche", "vc": "Violoncello",
      "kb": "KontrabaÃŸ", "sv": "Solo Violine", "sva": "Solo Bratsche", "svc": "Solo Violoncello", "skb": "Solo KontrabaÃŸ",
      "fl": "FlÃ¶te", "pic": "Piccolo", "ob": "Oboe", "eh": "Englischhorn", "cl": "Klarinette", "escl": "Es-Klarinette",
      "bcl": "Bassklarinette", "fg": "Fagott", "cfg": "Kontrafagott", "tr": "Trompete", "pis": "Piston",
      "phr": "Posthorn", "hr": "Horn", "thr": "Tenorhorn", "ohr": "Obligates Horn", "fhr": "FlÃ¼gelhorn",
      "whr": "Waldhorn", "pos": "Posaune", "bt": "Basstuba", "pau": "Pauken", "gtr": "GroÃŸe Trommel",
      "ktr": "Kleine Trommel", "mtr": "MilitÃ¤r Trommel", "bec": "Becken", "tam": "Tam-tam", "tri": "Triangel",
      "gls": "Glockenspiel", "hgl": "Herdenglocken", "gl": "Glocken", "ham": "Hammer", "rt": "Rute",
      "cel": "Celesta", "hp": "Harfe", "org": "Orgel", "klv": "Klavier", "har": "Harmonium", "git": "Gitarre",
      "man": "Mandoline", "sop": "Sopran", "alt": "Alto", "ten": "Tenor", "bar": "Bariton", "bass": "Bass",
      "sop1": "Sopran1", "sop2": "Sopran2", "alt1": "Alto1", "alt2": "Alto2", "kalt": "Knabe(Alto)",
      "chor": "Chor", "chor1": "Chor1", "chor2": "Chor2", "fchor": "frauen Chor", "kchor": "knaben Chor", "sti": "Stimme"
    };

    // Make dMapping available globally
    window.dMapping = dMapping;

    // Work Name to Code Mapping
    const aMapping = {
      "all": "ALL", "äº¤éŸ¿æ›²ç¬¬1ç•ªãƒ‹é•·èª¿ï¼ˆ1884-88ï¼‰": "1", "äº¤éŸ¿æ›²ç¬¬2ç•ªãƒçŸ­èª¿ï¼ˆ1888-94ï¼‰": "2",
      "äº¤éŸ¿æ›²ç¬¬3ç•ªãƒ‹çŸ­èª¿ï¼ˆ1893-96ï¼‰": "3", "äº¤éŸ¿æ›²ç¬¬4ç•ªãƒˆé•·èª¿ï¼ˆ1899-1900ï¼‰": "4", "äº¤éŸ¿æ›²ç¬¬5ç•ªå¬°ãƒçŸ­èª¿ï¼ˆ1901-02ï¼‰": "5",
      "äº¤éŸ¿æ›²ç¬¬6ç•ªã‚¤çŸ­èª¿ï¼ˆ1903-04ï¼‰": "6", "äº¤éŸ¿æ›²ç¬¬7ç•ªãƒ›çŸ­èª¿ï¼ˆ1904-05ï¼‰": "7", "äº¤éŸ¿æ›²ç¬¬8ç•ªå¤‰ãƒ›é•·èª¿ï¼ˆ1906ï¼‰": "8",
      "äº¤éŸ¿æ›²ã‚¤çŸ­èª¿ã€å¤§åœ°ã®æ­Œã€ï¼ˆ1908ï¼‰": "a", "äº¤éŸ¿æ›²ç¬¬9ç•ªãƒ‹é•·èª¿ï¼ˆ1909ï¼‰": "9", "äº¤éŸ¿æ›²ç¬¬10ç•ªå¬°ãƒ˜é•·èª¿ï¼ˆ1910ï¼‰": "101",
      "äº¤éŸ¿æ›²ç¬¬10ç•ªï¼ˆã‚¯ãƒƒã‚¯ç‰ˆï¼‰": "102", "å˜†ãã®æ­Œï¼ˆ1880ï¼‰": "b1", "å˜†ãã®æ­Œï¼ˆ1899ï¼‰": "b2",
      "ã•ã™ã‚‰ã†è‹¥äººã®æ­Œ": "c", "å­ä¾›ã®é­”æ³•ã®è§’ç¬›": "d", "å­ä¾›ã®æ­»ã®æ­Œ": "e",
      "ãƒªãƒ¥ãƒƒã‚±ãƒ«ãƒˆã®è©©ã«ã‚ˆã‚‹5ã¤ã®æ­Œ": "f", "èŠ±ã®ç« ": "g", "è‘¬ç¤¼": "h"
    };

    const aReverseMap = Object.entries(aMapping).reduce((acc, [key, value]) => {
      acc[value.toLowerCase()] = key;
      return acc;
    }, {});

    // æ¥½å™¨ç¾¤ã®ALLé¸æŠæ™‚ã®è¡¨ç¤ºåãƒãƒƒãƒ”ãƒ³ã‚°
    const groupAllDisplayMap = {
      'ALL_STRINGS': 'å¼¦æ¥½å™¨ç¾¤',
      'ALL_WOODWINDS': 'æœ¨ç®¡æ¥½å™¨ç¾¤',
      'ALL_BRASS': 'é‡‘ç®¡æ¥½å™¨ç¾¤',
      'ALL_PERCUSSIONS': 'æ‰“æ¥½å™¨ç¾¤ãªã©',
      'ALL_VOCAL': 'å£°æ¥½ãƒ»åˆå”±'
    };

    window._allGlobalSelected = false;
    let currentSearchId = 0;

    window.addEventListener('DOMContentLoaded', async () => {
      // ã€Œã™ã¹ã¦ã®æ›²ã‚’é¸æŠã€ãƒœã‚¿ãƒ³
      document.getElementById('all-works-button').addEventListener('click', e => {
        selectAllWorks();
      });

      // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸçŠ¶æ…‹ã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«èƒŒæ™¯ã‚’ä»˜ä¸
      const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      allCheckboxes.forEach(ch => {
        if (ch.checked) {
          ch.parentElement.classList.add('checked');
        }
        ch.addEventListener('click', e => {
          setTimeout(() => {
            if (ch.checked) {
              ch.parentElement.classList.add('checked');
            } else {
              ch.parentElement.classList.remove('checked');
            }
            updateSelectionSummary();
          }, 0);
        });
      });

      // ã‚°ãƒ«ãƒ¼ãƒ—ã§ã€ŒALLã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰ä»–ã‚’OFFã«ã—ã€å¤–ã•ã‚ŒãŸã‚‰å…¨éƒ¨å¤–ã™ãªã©ã®æ’ä»–åˆ¶å¾¡
      const groupIds = ['works', 'strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      groupIds.forEach(groupId => {
        const fieldset = document.getElementById(groupId);
        if (!fieldset) return;

        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(chk => {
          chk.addEventListener('click', e => {
            setTimeout(() => {
              window._allGlobalSelected = false;
              if (e.target.value.toLowerCase() === 'all') {
                if (e.target.checked) {
                  checkboxes.forEach(other => {
                    if (other !== e.target) {
                      other.checked = false;
                      other.parentElement.classList.remove('checked');
                    }
                  });
                } else {
                  checkboxes.forEach(other => {
                    other.checked = false;
                    other.parentElement.classList.remove('checked');
                  });
                }
              } else {
              if (e.target.checked) {
                  const allBox = fieldset.querySelector('input[value="ALL"]');
                  if (allBox) {
                    allBox.checked = false;
                    allBox.parentElement.classList.remove('checked');
                  }
                }
              }
              updateSelectionSummary();
            }, 0);
          });
        });
      });

      // å„ç®‡æ‰€ã®ã€ŒALLã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å€‹åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('all-works').addEventListener('click', e => {
        const allWorksCheckbox = e.target;
        const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]:not(#all-works)');
        if (allWorksCheckbox.checked) {
          workCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-strings').addEventListener('click', e => {
        const allStringsCheckbox = e.target;
        const stringCheckboxes = document.querySelectorAll('#strings input[type="checkbox"]:not(#all-strings)');
        if (allStringsCheckbox.checked) {
          stringCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-woodwinds').addEventListener('click', e => {
        const allWoodwindsCheckbox = e.target;
        const woodwindsCheckboxes = document.querySelectorAll('#woodwinds input[type="checkbox"]:not(#all-woodwinds)');
        if (allWoodwindsCheckbox.checked) {
          woodwindsCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-brass').addEventListener('click', e => {
        const allBrassCheckbox = e.target;
        const brassCheckboxes = document.querySelectorAll('#brass input[type="checkbox"]:not(#all-brass)');
        if (allBrassCheckbox.checked) {
          brassCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-percussions').addEventListener('click', e => {
        const allPercussionsCheckbox = e.target;
        const percussionsCheckboxes = document.querySelectorAll('#percussions input[type="checkbox"]:not(#all-percussions)');
        if (allPercussionsCheckbox.checked) {
          percussionsCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      document.getElementById('all-vocal').addEventListener('click', e => {
        const allVocalCheckbox = e.target;
        const vocalCheckboxes = document.querySelectorAll('#vocal input[type="checkbox"]:not(#all-vocal)');
        if (allVocalCheckbox.checked) {
          vocalCheckboxes.forEach(chk => {
            chk.checked = false;
            chk.parentElement.classList.remove('checked');
          });
          updateSelectionSummary();
        }
      });

      // ã€Œã™ã¹ã¦ã®æ¥½å™¨ã‚’é¸æŠã€ãƒœã‚¿ãƒ³
      document.getElementById('all-instruments').addEventListener('click', e => {
        selectAllInAllGroups();
      });

      // ã€Œæ¥½å™¨ã‚’ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³
      document.getElementById('clear-instruments').addEventListener('click', e => {
        deselectAllInAllGroups();
      });

      // Load data locally
      if (typeof loadData === 'function') {
        try {
            await loadData('mahler');
        } catch (e) {
            console.error("Failed to load data:", e);
        }
      }

      updateSelectionSummary();
      updateFloatingBarOffset();
    });

    function selectAllInAllGroups() {
      deselectAllInAllGroups();
      const instrumentGroupIds = ['strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      instrumentGroupIds.forEach(id => {
        const fieldset = document.getElementById(id);
        if (!fieldset) return;
        const allBox = fieldset.querySelector('input[value="ALL"]');
        if (allBox) {
          allBox.checked = true;
          allBox.parentElement.classList.add('checked');
        }
      });
      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox) {
        conductorCheckbox.checked = true;
        conductorCheckbox.parentElement.classList.add('checked');
      }
      document.querySelectorAll('.instrument-group:not(#works-group)').forEach(d => {
        d.open = true;
      });
      window._allGlobalSelected = true;
      updateSelectionSummary();
    }

    function deselectAllInAllGroups() {
      const instrumentGroupIds = ['strings', 'woodwinds', 'brass', 'percussions', 'vocal'];
      instrumentGroupIds.forEach(id => {
        const fieldset = document.getElementById(id);
        if (!fieldset) return;
        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(chk => {
          chk.checked = false;
          chk.parentElement.classList.remove('checked');
        });
      });
      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox) {
        conductorCheckbox.checked = false;
        conductorCheckbox.parentElement.classList.remove('checked');
      }
      document.querySelectorAll('.instrument-group:not(#works-group)').forEach(d => {
        d.open = false;
      });
      window._allGlobalSelected = false;
      updateSelectionSummary();
    }

    function cancelSearch() {
      const searchButton = document.querySelector('#floating-bar .btn-action');
      const resultsDiv = document.getElementById('results');
      currentSearchId++;
      resultsDiv.innerHTML = '<div class="result-message">æ¤œç´¢ãŒä¸­æ­¢ã•ã‚Œã¾ã—ãŸã€‚</div>';
      searchButton.disabled = false;
    }

    function formatMovementNumber(a, b) {
      const specialMapping = {
        c: { c1: "Wenn mein Schatz Hochzeit macht", c2: "Ging heut' morgen Ã¼ber's Feld", c3: "Ich hab' ein glÃ¼hend Messer", c4: "Die zwei blauen Augen von meinem Schatz" },
        d: { d01: "Der Schildwache Nachlied", d02: "Verlorne MÃ¼h'!", d03: "Trost im UnglÃ¼ck", d04: "Das himmlische Leben", d05: "Wer hat dies Liedel erdacht?", d06: "Das irdische Leben", d07: "Urlicht", d08: "Des Antonius von Padua Fischpredigt", d09: "Rheinlegendchen", d10: "Lob des hohen Verstands", d11: "Lied des Verfolgten im Turm", d12: "Wo die schÃ¶nen Trompeten blasen", d13: "Revelge", d14: "Der Tamboursg'sell" },
        e: { e1: "Nun will die Sonn' so hell aufgeh'n", e2: "Nun seh' ich wohl, warum so dunkle Flammen", e3: "Wenn dein MÃ¼tterlein", e4: "Oft denk' ich, sie sind nur ausgegangen", e5: "In diesem Wetter, in diesem Braus" },
        f: { f1: "Blicke mir nicht in die Lieder!", f2: "Ich atmet' einen linden Duft", f3: "Ich bin der Welt abhanden gekommen", f4: "Um Mitternacht", f5: "Liebst du um SchÃ¶nheit" }
      };

      if (specialMapping[a.toLowerCase()] && specialMapping[a.toLowerCase()][b.toLowerCase()]) {
        return specialMapping[a.toLowerCase()][b.toLowerCase()];
      }
      if (b.toLowerCase() === 't1') return 'ç¬¬1éƒ¨';
      if (b.toLowerCase() === 't2') return 'ç¬¬2éƒ¨';
      if (b.toLowerCase() === 't3') return 'ç¬¬3éƒ¨';
      if (['a', 'g', 'h'].includes(b.toLowerCase())) return '';
      return `ç¬¬${b}æ¥½ç« `;
    }

    function escapeHtml(str) {
      const value = (str === null || str === undefined) ? '' : String(str);
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function escapeHtmlWithBreaks(str) {
      return escapeHtml(str).replace(/(?:\r\n|\r|\n)/g, '<br>');
    }

    window.searchMahlerDataLocal = async function(works, instruments, includeOrchestraAll) {
      console.log("searchMahlerDataLocal called");
      const data = window.appData.mahler;
      if (!data) {
        console.error("Data missing");
        return [];
      }
      console.log("Data loaded", data.length);

      const groupAllMap = {
        "all_strings": ["v1", "v2", "va", "vc", "kb", "sv", "sva", "svc", "skb"],
        "all_woodwinds": ["fl", "pic", "ob", "eh", "cl", "escl", "bcl", "fg", "cfg"],
        "all_brass": ["tr", "pis", "phr", "hr", "thr", "ohr", "fhr", "whr", "pos", "bt"],
        "all_percussions": ["pau", "gtr", "ktr", "mtr", "bec", "tam", "tri", "gls", "hgl", "gl", "ham", "rt", "cel", "hp", "org", "klv", "har", "git", "man"],
        "all_vocal": ["sop", "alt", "ten", "bar", "bass", "sop1", "sop2", "alt1", "alt2", "kalt", "chor", "chor1", "chor2", "fchor", "kchor", "sti"]
      };

      let finalInstruments = new Set();

      if (instruments.includes('ALL_GLOBAL')) {
        Object.keys(window.dMapping).forEach(code => {
          if (code !== 'all') finalInstruments.add(code);
        });
        finalInstruments.add('all');
      } else {
        instruments.forEach(val => {
          const lowerVal = val.toLowerCase();
          if (groupAllMap[lowerVal]) {
            groupAllMap[lowerVal].forEach(code => finalInstruments.add(code));
          } else if (window.dMapping[lowerVal]) {
            finalInstruments.add(lowerVal);
          }
        });
      }

      if (includeOrchestraAll) {
        finalInstruments.add('all');
      }

      const results = [];
      let totalMatches = 0;

      for (const row of data) {
        const deData = row.de;
        const jaData = row.ja;
        const dataCol = row.data;

        if (!dataCol || typeof dataCol !== 'string') continue;

        const segments = dataCol.split('&').map(s => s.trim()).filter(s => s);
        if (segments.length === 0) continue;

        let matchedLocList = [];
        let segmentCount = 0;

        segments.forEach(seg => {
          const [prefix, a, b, c, d] = seg.split('-');
          if (!a || !b || !c || !d) return;

          let aMatch = works[0] === 'ALL' || works.some(choice => aMapping[choice] === a);

          const dArr = d.split(',').map(x => x.trim());
          let dMatch = dArr.some(origCode => {
            const codeLower = origCode.toLowerCase();
            if (includeOrchestraAll) {
              return finalInstruments.has(codeLower) || codeLower === 'all';
            } else {
              return finalInstruments.has(codeLower) && codeLower !== 'all';
            }
          });

          if (aMatch && dMatch) {
            totalMatches++;
            segmentCount++;

            const aLabel = aReverseMap[a.toLowerCase()] || `ä¸æ˜(${a})`;
            const movementText = formatMovementNumber(a, b);
            const measureText = `ç¬¬${c}å°ç¯€`;
            const mappedInstruments = dArr.map(code => window.dMapping[code] || code).join(', ');
            // Modified format: wrap instruments in ã€ã€‘
            const locText = `${aLabel} ${movementText}ï¼š${measureText} ã€${mappedInstruments}ã€‘`;
            matchedLocList.push(locText);
          }
        });

        if (matchedLocList.length > 0) {
          results.push({
              de: deData,
              ja: jaData,
              locs: matchedLocList,
              count: segmentCount
          });
        }
      }

      return results;
    };

    function focusResultsPanel(options) {
      const resultsDiv = document.getElementById('results');
      if (resultsDiv) {
        resultsDiv.scrollIntoView({ behavior: options && options.instant ? 'auto' : 'smooth' });
      }
    }

    function search() {
      const searchButton = document.querySelector('#floating-bar .btn-action');
      const resultsDiv = document.getElementById('results');
      const loadingHtml = '<p class="loading">æ¤œç´¢ä¸­ãƒ»ãƒ»ãƒ»</p>';
      resultsDiv.innerHTML = loadingHtml;

      focusResultsPanel({ instant: true });

      const works = getSelectedWorks();
      const instruments = getSelectedInstruments();
      const includeOrchestraAll = document.querySelector('input[name="include-orchestra-all"]:checked').value === 'on';

      if (works.length === 0) {
        resultsDiv.innerHTML = '<p class="loading">æ›²åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
        searchButton.disabled = false;
        focusResultsPanel({ instant: true });
        return;
      }

      if (!includeOrchestraAll && instruments.length === 0) {
        resultsDiv.innerHTML = '<p class="loading">æ¥½å™¨ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
        searchButton.disabled = false;
        focusResultsPanel({ instant: true });
        return;
      }

      searchButton.disabled = true;
      currentSearchId++;
      const thisSearchId = currentSearchId;

      setTimeout(async () => {
          try {
              if (typeof window.searchMahlerDataLocal === 'function') {
                  const results = await window.searchMahlerDataLocal(works, instruments, includeOrchestraAll);
                  renderSearchResults(results);
                  searchButton.disabled = false;

                      // Send notification
                  if (typeof sendSearchNotification === 'function') {
                      const details = {
                          work: works.join(', '),
                          scope: instruments.join(', '),
                          term: 'Mahler Search',
                          includeGlobal: includeOrchestraAll
                      };
                      sendSearchNotification(details, 'index.html');
                  }
              } else {
                  console.error("window.searchMahlerDataLocal is not a function");
                  resultsDiv.innerHTML = '<div class="result-message">æ¤œç´¢æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (searchMahlerDataLocal missing)</div>';
                  searchButton.disabled = false;
              }
          } catch (e) {
              console.error("Search failed:", e);
              resultsDiv.innerHTML = `<div class="result-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}</div>`;
              searchButton.disabled = false;
          }
      }, 100);
    }

    // Lazy Loading State for Search Results
    let currentSearchResults = [];
    let currentSearchIndex = 0;
    const SEARCH_BATCH_SIZE = 50;
    let searchObserver = null;

    function renderSearchResults(results) {
        const container = document.getElementById('results');
        container.innerHTML = "";

        if (!results || results.length === 0) {
            container.innerHTML = '<div class="result-message">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            return;
        }

        container.innerHTML = `<div class="result-message">${results.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼</div><div id="result-list"></div>`;
        const listContainer = document.getElementById('result-list');

        currentSearchResults = results;
        currentSearchIndex = 0;

        if (searchObserver) searchObserver.disconnect();
        searchObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadMoreSearchResults();
            }
        }, { rootMargin: '200px' });

        loadMoreSearchResults();
    }

    function loadMoreSearchResults() {
        const listContainer = document.getElementById('result-list');
        if (!listContainer) return;

        const fragment = document.createDocumentFragment();
        const end = Math.min(currentSearchIndex + SEARCH_BATCH_SIZE, currentSearchResults.length);

        // Remove sentinel
        const sentinel = document.getElementById('search-sentinel');
        if (sentinel) sentinel.remove();

        for (let i = currentSearchIndex; i < end; i++) {
            const item = currentSearchResults[i];
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('result-entry');

            let html = `<div class="result-a">${window.linkTermsInTranslation ? window.linkTermsInTranslation(item.de, window.appData.dic_terms_index) : escapeHtmlWithBreaks(item.de)}</div>`;
            html += `<div class="result-c">${escapeHtmlWithBreaks(item.ja)}</div>`;
            item.locs.forEach(loc => {
                html += `<div class="result-loc">${escapeHtml(loc)}</div>`;
            });
            html += `<div class="result-loc">(${item.count}ä»¶)</div>`;
            
            entryDiv.innerHTML = html;
            fragment.appendChild(entryDiv);
        }

        listContainer.appendChild(fragment);
        currentSearchIndex = end;

        if (currentSearchIndex < currentSearchResults.length) {
            const newSentinel = document.createElement('div');
            newSentinel.id = 'search-sentinel';
            newSentinel.style.height = '20px';
            newSentinel.textContent = 'Loading more...';
            listContainer.appendChild(newSentinel);
            searchObserver.observe(newSentinel);
        }
    }

    function getSelectedInstruments() {
      let selected = [];
      const groupMappings = {
        'strings': 'ALL_STRINGS',
        'woodwinds': 'ALL_WOODWINDS',
        'brass': 'ALL_BRASS',
        'percussions': 'ALL_PERCUSSIONS',
        'vocal': 'ALL_VOCAL'
      };

      for (const [groupId, allValue] of Object.entries(groupMappings)) {
        const fieldset = document.getElementById(groupId);
        if (!fieldset) continue;
        const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
        let allChecked = false;
        let normalValues = [];
        checkboxes.forEach(chk => {
          if (chk.value.toLowerCase() === 'all') {
            if (chk.checked) allChecked = true;
          } else {
            if (chk.checked) normalValues.push(chk.value.toLowerCase());
          }
        });
        if (allChecked) {
          selected.push(allValue);
        } else {
          selected.push(...normalValues);
        }
      }

      const conductorCheckbox = document.querySelector('#conductor input[type="checkbox"]');
      if (conductorCheckbox && conductorCheckbox.checked) {
        selected.push('dir');
      }

      if (window._allGlobalSelected) {
        selected.push('ALL_GLOBAL');
      }

      return selected;
    }

    function getSelectedWorks() {
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]');
      const selected = Array.from(workCheckboxes).filter(chk => chk.checked).map(chk => chk.value.toLowerCase());
      return selected.includes('all') ? ['ALL'] : selected;
    }

    /**
     * æ›²åã‚’ã™ã¹ã¦é¸æŠ
     */
    function selectAllWorks() {
      // æ›²åã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã
      const worksDetails = document.getElementById('works-group');
      if (worksDetails) worksDetails.open = true;

      // ã€ŒALLã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ONã«ã™ã‚‹
      const allWorksCheckbox = document.getElementById('all-works');

      if (allWorksCheckbox) {
        allWorksCheckbox.checked = true;
        allWorksCheckbox.parentElement.classList.add('checked');
      }

      // ä»–ã®æ›²åãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’OFFã«ã™ã‚‹
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]:not(#all-works)');

      workCheckboxes.forEach(chk => {
        chk.checked = false;
        chk.parentElement.classList.remove('checked');
      });

      updateSelectionSummary();
    }

    /**
     * æ›²åã‚’ã‚¯ãƒªã‚¢
     */
    function clearWorks() {
      const workCheckboxes = document.querySelectorAll('#works input[type="checkbox"]');

      workCheckboxes.forEach(chk => {
        chk.checked = false;
        chk.parentElement.classList.remove('checked');
      });
      // æ›²åã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆworks-groupï¼‰ã‚’é–‰ã˜ã‚‹
      const worksDetails = document.getElementById('works-group');
      if (worksDetails) worksDetails.open = false;
      updateSelectionSummary();
    }

    /**
  * é¸æŠçŠ¶æ³ã®ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°ã™ã‚‹
  */
    function updateSelectionSummary() {
      const summaryDiv = document.getElementById('selection-summary');
      if (!summaryDiv) return;

      const selectedWorks = getSelectedWorks();
      const selectedInstruments = getSelectedInstruments();

      const workLabelMap = {}

        ;

      document.querySelectorAll('#works input[type="checkbox"]').forEach(chk => {
        const key = chk.value.toLowerCase();
        const labelText = chk.parentElement ? chk.parentElement.textContent.trim() : chk.value;
        workLabelMap[key] = labelText;
      });

      let workValue = 'ãªã—';

      if (selectedWorks.length > 0) {
        if (selectedWorks[0] === 'ALL') {
          workValue = 'ã™ã¹ã¦';
        }

        else {
          const workNames = selectedWorks.map(code => workLabelMap[code] || code);

          if (workNames.length > 0) {
            workValue = workNames.join('<br>');
          }
        }
      }

      let instrumentValue = 'ãªã—';

      if (selectedInstruments.length > 0) {
        if (selectedInstruments.includes('ALL_GLOBAL')) {
          instrumentValue = 'ã™ã¹ã¦';
        }

        else {
          const instrumentNames = selectedInstruments.map(code => groupAllDisplayMap[code] || window.dMapping[code.toLowerCase()] || code).filter(name => name && name !== 'ALL_GLOBAL');

          if (instrumentNames.length > 0) {
            instrumentValue = instrumentNames.join('<br>');
          }
        }
      }

      
      // ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©å…¨ä½“è¨­å®šã®å–å¾—
      const includeOrchRadio = document.querySelector('input[name="include-orchestra-all"]:checked');
      let includeOrchMsg = '';
      if (includeOrchRadio) {
          if (includeOrchRadio.value === 'off') {
              includeOrchMsg = '<span style="color:#d32f2f; margin-left: 8px;">(ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©å…¨ä½“ã¸ã®æŒ‡ç¤ºã¯å«ã‚ãªã„)</span>';
          } else {
              includeOrchMsg = '<span style="color:#388e3c; margin-left: 8px;">(ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©å…¨ä½“ã¸ã®æŒ‡ç¤ºã‚’å«ã‚ã‚‹)</span>';
          }
      }

      summaryDiv.innerHTML = '<div class="summary-block">' + '<div class="summary-title">é¸æŠã—ãŸæ›²ï¼š</div>' + '<div class="summary-value">' + workValue + '</div>' + '</div>' + '<div class="summary-block">' + '<div class="summary-title">é¸æŠã—ãŸæ¥½å™¨ï¼š' + includeOrchMsg + '</div>' + '<div class="summary-value">' + instrumentValue + '</div>' + '</div>';

      adjustFloatingBarSpacing();
    }

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[name="include-orchestra-all"]').forEach(radio => {
            radio.addEventListener('change', updateSelectionSummary);
        });
        // åˆæœŸè¡¨ç¤ºæ›´æ–°
        updateSelectionSummary();
    });

    function adjustFloatingBarSpacing() {
      const floatingBar = document.getElementById('floating-bar');
      const container = document.querySelector('.container');
      if (!floatingBar || !container) return;

      const barHeight = floatingBar.offsetHeight;
      const safeArea = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-bottom')) || 0;
      const offset = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--floating-bar-offset')) || 0;
      container.style.paddingBottom = (barHeight + 40 + safeArea + offset) + 'px';
    }

    function updateFloatingBarOffset() {
      let offset = 16;
      if (window.visualViewport) {
        const diff = window.innerHeight - window.visualViewport.height;
        if (diff > 0) offset += diff;
      }
      document.documentElement.style.setProperty('--floating-bar-offset', `${offset}px`);
      
      // Throttle using requestAnimationFrame
      if (!window._throttleTimer) {
        window._throttleTimer = requestAnimationFrame(() => {
          adjustFloatingBarSpacing();
          window._throttleTimer = null;
        });
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateFloatingBarOffset);
      window.visualViewport.addEventListener('scroll', updateFloatingBarOffset);
    }

  </script>
</head>

<body>
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="sidebar" id="sidebar">
    <h3 class="sidebar-home"><a href="home.html">ğŸ  HOME</a></h3>
    <h3>Richard Wagner (RW)</h3>
    <ul>
      <li><a href="richard_wagner.html">æ›²åã‹ã‚‰æ¤œç´¢</a></li>
      <li><a href="rw_terms_search.html">ç”¨èªã‹ã‚‰æ¤œç´¢</a></li>
    </ul>

    <h3>Gustav Mahler (GM)</h3>
    <ul>
      <li><a href="index.html">æ›²åã¨æ¥½å™¨ç­‰ã‹ã‚‰æ¤œç´¢</a></li>
      <li><a href="terms_search.html">ç”¨èªã‹ã‚‰æ¤œç´¢</a></li>
    </ul>

    <h3>Richard Strauss (RS)</h3>
    <ul>
      <li><a href="richard_strauss.html">æ›²åã‹ã‚‰æ¤œç´¢</a></li>
      <li><a href="rs_terms_search.html">ç”¨èªã‹ã‚‰æ¤œç´¢</a></li>
    </ul>

    <h3>ç”¨èªé›†</h3>
    <ul>
      <li><a href="dic.html">ãƒ‰ã‚¤ãƒ„èªã®éŸ³æ¥½ç”¨èªé›†</a></li>
    </ul>


  </nav>

  <div class="page-wrapper" role="main">
    <div class="container">
      <div class="home-link"><a href="home.html">HOME</a></div>
      <h1>æ›²åã¨æ¥½å™¨ã‹ã‚‰æ¤œç´¢ (GM)</h1>
    <p><span style="font-size: 0.9rem;">å„ç”¨èªã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯</span><a href="dic.html" target="_blank" style="font-size: 1.2rem; font-weight: bold; color: var(--button-bg); text-decoration: none; border-bottom: 2px solid transparent; transition: all 0.2s ease;">ç”¨èªé›†</a><span style="font-size: 0.9rem;">ã‚’å‚ç…§</span></p>
    <!-- æ›²åã‚¨ãƒªã‚¢ -->
      <div class="big-label">æ›²åã‚’é¸æŠ </div>
      <div style="margin-bottom: 15px;"><button type="button" id="all-works-button"
          class="btn-action">ã™ã¹ã¦ã®æ›²ã‚’é¸æŠ</button><button type="button" onclick="clearWorks()"
          class="btn-clear">æ›²åã‚’ã‚¯ãƒªã‚¢</button></div>
      <!-- æ›²åã‚’ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åŒ–: instrument-group ã®æŒ™å‹•ã«åˆã‚ã›ã‚‹ -->
        <details class="instrument-group" id="works-group">
          <summary>æ›²å</summary>
          <fieldset id="works">
            <!-- ALLãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ --><label class="all-label"><input type="checkbox" id="all-works" value="ALL">ALL </label>
              <div class="inner-checkbox-group checkbox-grid-songs">
                <!-- æ›²åãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç¾¤ --><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬1ç•ªãƒ‹é•·èª¿ï¼ˆ1884-88ï¼‰">äº¤éŸ¿æ›²ç¬¬1ç•ªãƒ‹é•·èª¿ï¼ˆ1884-88ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬2ç•ªãƒçŸ­èª¿ï¼ˆ1888-94ï¼‰">äº¤éŸ¿æ›²ç¬¬2ç•ªãƒçŸ­èª¿ï¼ˆ1888-94ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬3ç•ªãƒ‹çŸ­èª¿ï¼ˆ1893-96ï¼‰">äº¤éŸ¿æ›²ç¬¬3ç•ªãƒ‹çŸ­èª¿ï¼ˆ1893-96ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬4ç•ªãƒˆé•·èª¿ï¼ˆ1899-1900ï¼‰">äº¤éŸ¿æ›²ç¬¬4ç•ªãƒˆé•·èª¿ï¼ˆ1899-1900ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬5ç•ªå¬°ãƒçŸ­èª¿ï¼ˆ1901-02ï¼‰">äº¤éŸ¿æ›²ç¬¬5ç•ªå¬°ãƒçŸ­èª¿ï¼ˆ1901-02ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬6ç•ªã‚¤çŸ­èª¿ï¼ˆ1903-04ï¼‰">äº¤éŸ¿æ›²ç¬¬6ç•ªã‚¤çŸ­èª¿ï¼ˆ1903-04ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬7ç•ªãƒ›çŸ­èª¿ï¼ˆ1904-05ï¼‰">äº¤éŸ¿æ›²ç¬¬7ç•ªãƒ›çŸ­èª¿ï¼ˆ1904-05ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬8ç•ªå¤‰ãƒ›é•·èª¿ï¼ˆ1906ï¼‰">äº¤éŸ¿æ›²ç¬¬8ç•ªå¤‰ãƒ›é•·èª¿ï¼ˆ1906ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ã‚¤çŸ­èª¿ã€å¤§åœ°ã®æ­Œã€ï¼ˆ1908ï¼‰">äº¤éŸ¿æ›²ã‚¤çŸ­èª¿ã€å¤§åœ°ã®æ­Œã€ï¼ˆ1908ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬9ç•ªãƒ‹é•·èª¿ï¼ˆ1909ï¼‰">äº¤éŸ¿æ›²ç¬¬9ç•ªãƒ‹é•·èª¿ï¼ˆ1909ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬10ç•ªå¬°ãƒ˜é•·èª¿ï¼ˆ1910ï¼‰">äº¤éŸ¿æ›²ç¬¬10ç•ªå¬°ãƒ˜é•·èª¿ï¼ˆ1910ï¼‰</label><label><input type="checkbox"
                      value="äº¤éŸ¿æ›²ç¬¬10ç•ªï¼ˆã‚¯ãƒƒã‚¯ç‰ˆï¼‰">äº¤éŸ¿æ›²ç¬¬10ç•ªï¼ˆã‚¯ãƒƒã‚¯ç‰ˆï¼‰</label><label><input type="checkbox"
                      value="å˜†ãã®æ­Œï¼ˆ1880ï¼‰">å˜†ãã®æ­Œï¼ˆ1880ï¼‰</label><label><input type="checkbox"
                      value="å˜†ãã®æ­Œï¼ˆ1899ï¼‰">å˜†ãã®æ­Œï¼ˆ1899ï¼‰</label><label><input type="checkbox"
                      value="ã•ã™ã‚‰ã†è‹¥äººã®æ­Œ">ã•ã™ã‚‰ã†è‹¥äººã®æ­Œ</label><label><input type="checkbox"
                      value="å­ä¾›ã®é­”æ³•ã®è§’ç¬›">å­ä¾›ã®é­”æ³•ã®è§’ç¬›</label><label><input type="checkbox"
                      value="å­ä¾›ã®æ­»ã®æ­Œ">å­ä¾›ã®æ­»ã®æ­Œ</label><label><input type="checkbox"
                      value="ãƒªãƒ¥ãƒƒã‚±ãƒ«ãƒˆã®è©©ã«ã‚ˆã‚‹5ã¤ã®æ­Œ">ãƒªãƒ¥ãƒƒã‚±ãƒ«ãƒˆã®è©©ã«ã‚ˆã‚‹5ã¤ã®æ­Œ</label><label><input type="checkbox"
                      value="èŠ±ã®ç« ">èŠ±ã®ç« </label><label><input type="checkbox" value="è‘¬ç¤¼">è‘¬ç¤¼</label>
              </div>
          </fieldset>
        </details>
        <!-- æ¥½å™¨é¸æŠã‚¨ãƒªã‚¢ -->
          <div class="big-label-instruments">æ¥½å™¨ã‚’é¸æŠ </div>
          <div style="margin-bottom: 15px;"><button type="button" id="all-instruments"
              class="btn-action">ã™ã¹ã¦ã®æ¥½å™¨ã‚’é¸æŠ</button><button type="button" id="clear-instruments"
              class="btn-clear">æ¥½å™¨ã‚’ã‚¯ãƒªã‚¢</button>
            <div style="margin-top: 10px;">
              <!-- ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©å…¨ä½“ã‚’å«ã‚ã‚‹ã‹ã©ã†ã‹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ --><label style="display: block; margin-bottom: 5px;"><input type="radio"
                    name="include-orchestra-all" value="on" checked>ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©å…¨ä½“ã¸ã®æŒ‡ç¤ºã‚’å«ã‚ã‚‹ </label><label
                  style="display: block; margin-bottom: 15px;"><input type="radio" name="include-orchestra-all"
                    value="off">å«ã‚ãªã„ </label>
            </div>
          </div>
          <!-- æŒ‡æ®è€… -->
            <details class="instrument-group">
              <summary>æŒ‡æ®è€…</summary>
              <fieldset id="conductor">
                <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                      value="dir">Dirigent</label></div>
              </fieldset>
            </details>
            <!-- å¼¦æ¥½å™¨ç¾¤ -->
              <details class="instrument-group">
                <summary>å¼¦æ¥½å™¨ç¾¤</summary>
                <fieldset id="strings"><label class="all-label"><input type="checkbox" id="all-strings"
                      value="ALL">ALL</label>
                  <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                        value="v1">Violine1</label><label><input type="checkbox"
                        value="v2">Violine2</label><label><input type="checkbox" value="va">Bratsche</label><label><input
                        type="checkbox" value="vc">Violoncello</label><label><input type="checkbox"
                        value="kb">KontrabaÃŸ</label><label><input type="checkbox" value="sv">Solo
                      Violine</label><label><input type="checkbox" value="sva">Solo Bratsche</label><label><input
                        type="checkbox" value="svc">Solo Violoncello</label><label><input type="checkbox"
                        value="skb">Solo KontrabaÃŸ</label></div>
                </fieldset>
              </details>
              <!-- æœ¨ç®¡æ¥½å™¨ç¾¤ -->
                <details class="instrument-group">
                  <summary>æœ¨ç®¡æ¥½å™¨ç¾¤</summary>
                  <fieldset id="woodwinds"><label class="all-label"><input type="checkbox" id="all-woodwinds"
                        value="ALL">ALL</label>
                    <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                          value="fl">FlÃ¶te</label><label><input type="checkbox" value="pic">Piccolo</label><label><input
                          type="checkbox" value="ob">Oboe</label><label><input type="checkbox"
                          value="eh">Englischhorn</label><label><input type="checkbox"
                          value="cl">Klarinette</label><label><input type="checkbox"
                          value="escl">Es-Klarinette</label><label><input type="checkbox"
                          value="bcl">Bassklarinette</label><label><input type="checkbox" value="fg">Fagott</label>
                  </fieldset>
                </details>
                <!-- é‡‘ç®¡æ¥½å™¨ç¾¤ -->
                  <details class="instrument-group">
                    <summary>é‡‘ç®¡æ¥½å™¨ç¾¤</summary>
                    <fieldset id="brass"><label class="all-label"><input type="checkbox" id="all-brass"
                          value="ALL">ALL</label>
                      <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                            value="tr">Trompete</label><label><input type="checkbox"
                            value="pis">Piston</label><label><input type="checkbox"
                            value="phr">Posthorn</label><label><input type="checkbox"
                            value="hr">Horn</label><label><input type="checkbox"
                            value="thr">Tenorhorn</label><label><input type="checkbox" value="ohr">Obligates
                          Horn</label><label><input type="checkbox" value="fhr">FlÃ¼gelhorn</label><label><input
                            type="checkbox" value="whr">Waldhorn</label><label><input type="checkbox"
                            value="pos">Posaune</label><label><input type="checkbox" value="bt">Basstuba</label></div>
                    </fieldset>
                  </details>
                  <!-- æ‰“æ¥½å™¨ç¾¤ -->
                    <details class="instrument-group">
                      <summary>æ‰“æ¥½å™¨ç¾¤ãªã©</summary>
                      <fieldset id="percussions"><label class="all-label"><input type="checkbox" id="all-percussions"
                            value="ALL">ALL</label>
                        <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                              value="pau">Pauken</label><label><input type="checkbox" value="gtr">GroÃŸe
                            Trommel</label><label><input type="checkbox" value="ktr">Kleine Trommel</label><label><input
                              type="checkbox" value="mtr">MilitÃ¤r Trommel</label><label><input type="checkbox"
                              value="bec">Becken</label><label><input type="checkbox"
                              value="tam">Tam-tam</label><label><input type="checkbox"
                              value="tri">Triangel</label><label><input type="checkbox"
                              value="gls">Glockenspiel</label><label><input type="checkbox"
                              value="hgl">Herdenglocken</label><label><input type="checkbox"
                              value="gl">Glocken</label><label><input type="checkbox"
                              value="ham">Hammer</label><label><input type="checkbox"
                              value="rt">Rute</label><label><input type="checkbox"
                              value="cel">Celesta</label><label><input type="checkbox"
                              value="hp">Harfe</label><label><input type="checkbox"
                              value="org">Orgel</label><label><input type="checkbox"
                              value="klv">Klavier</label><label><input type="checkbox"
                              value="har">Harmonium</label><label><input type="checkbox"
                              value="git">Gitarre</label><label><input type="checkbox" value="man">Mandoline</label>
                        </div>
                      </fieldset>
                    </details>
                    <!-- å£°æ¥½ãƒ»åˆå”± -->
                      <details class="instrument-group">
                        <summary>å£°æ¥½ãƒ»åˆå”±</summary>
                        <fieldset id="vocal"><label class="all-label"><input type="checkbox" id="all-vocal"
                              value="ALL">ALL</label>
                          <div class="inner-checkbox-group checkbox-grid"><label><input type="checkbox"
                                value="sop">Sopran</label><label><input type="checkbox"
                                value="alt">Alto</label><label><input type="checkbox"
                                value="ten">Tenor</label><label><input type="checkbox"
                                value="bar">Bariton</label><label><input type="checkbox"
                                value="bass">Bass</label><label><input type="checkbox"
                                value="sop1">Sopran1</label><label><input type="checkbox"
                                value="sop2">Sopran2</label><label><input type="checkbox"
                                value="alt1">Alto1</label><label><input type="checkbox"
                                value="alt2">Alto2</label><label><input type="checkbox"
                                value="kalt">Knabe(Alto)</label><label><input type="checkbox"
                                value="chor">Chor</label><label><input type="checkbox"
                                value="chor1">Chor1</label><label><input type="checkbox"
                                value="chor2">Chor2</label><label><input type="checkbox" value="fchor">frauen
                              Chor</label><label><input type="checkbox" value="kchor">knaben Chor</label><label><input
                                type="checkbox" value="sti">Stimme</label></div>
                        </fieldset>
                      </details>
                      <!-- æ¤œç´¢çµæœè¡¨ç¤ºé ˜åŸŸ -->
                        <div id="results"></div>
  </div>
  <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¤œç´¢ãƒãƒ¼ -->
    <div id="floating-bar">
      <div id="selection-summary"></div>
      <div class="button-group"><button type="button" onclick="search()" class="btn-action">æ¤œç´¢</button><button
          type="button" onclick="cancelSearch()" class="btn-danger">ä¸­æ­¢</button></div>
    </div>
    <!-- ãƒšãƒ¼ã‚¸ã®ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div id="scrollToTop" onclick="scrollToTop()">â–² ãƒšãƒ¼ã‚¸ã®ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</div>
      <script>
        /*
         * common_scripts.html
         * å…¨ãƒšãƒ¼ã‚¸ã§å…±é€šã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰JavaScriptã€‚
         * ä¸»ã«ã€Œãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ãªã©ã€UIã®åŸºæœ¬çš„ãªå‹•ä½œã‚’å®šç¾©ã—ã¾ã™ã€‚
         */
        // Client-only helpers and UI glue. Guard against server (Apps Script) context.
        (function () {
          if (typeof window === 'undefined' || typeof document === 'undefined') {
            // Define no-op globals so server-side references do not throw
            this.scrollToTop = function () { };
            this.setResults = function () { };
            return;
          }
      
          // Helper: Throttle function to limit event firing frequency
          function throttle(func, limit) {
            let inThrottle;
            return function () {
              const args = arguments;
              const context = this;
              if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
              }
            }
          }
      
          // Show/hide the "back to top" button â€” use class toggles and run on load/resize/scroll
          // Throttled to avoid freezing on heavy pages
          let isScrolling = false;
          function updateScrollToTopVisibility() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (!scrollToTopBtn) {
              isScrolling = false; // ensure flag is reset even if btn missing
              return;
            }
            // show when scrolled down a bit
            if (window.scrollY > 300) {
              scrollToTopBtn.classList.add('show');
              scrollToTopBtn.classList.remove('hidden');
            } else {
              scrollToTopBtn.classList.remove('show');
              scrollToTopBtn.classList.add('hidden');
            }
            isScrolling = false;
          }
      
          function onScrollThrottled() {
            if (!isScrolling) {
              window.requestAnimationFrame(updateScrollToTopVisibility);
              isScrolling = true;
            }
          }
      
          window.addEventListener('scroll', onScrollThrottled, { passive: true });
      
          // Throttled resize handler for scroll-to-top visibility
          const throttledUpdateVisibility = throttle(updateScrollToTopVisibility, 200);
          window.addEventListener('resize', throttledUpdateVisibility);
          window.addEventListener('orientationchange', () => setTimeout(updateScrollToTopVisibility, 160));
      
          // ensure initial state after load (some mobile browsers change viewport after load)
          window.addEventListener('load', () => {
            updateScrollToTopVisibility();
            // second check shortly after to account for browser UI show/hide
            setTimeout(updateScrollToTopVisibility, 300);
          });
      
          // Expose global helpers
          function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
          window.scrollToTop = scrollToTop;
      
          function focusResultsPanel(options) {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;
      
            const topOffset = Math.max((resultsDiv.getBoundingClientRect().top + window.scrollY) - 20, 0);
            const behavior = options && options.instant ? 'auto' : 'smooth';
            window.scrollTo({ top: topOffset, behavior });
          }
          window.focusResultsPanel = focusResultsPanel;
      
          function setResults(html) {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;
            resultsDiv.innerHTML = html;
            focusResultsPanel({ instant: true });
          }
          window.setResults = setResults;
      
          // Fix garbled static texts for Wagner/Strauss pages
          document.addEventListener('DOMContentLoaded', () => {
            const isComposerPage = /Richard Wagner|Richard Strauss/.test(document.title);
            if (!isComposerPage) return;
      
            const firstP = document.querySelector('.container > p');
            if (firstP) firstP.textContent = 'ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã«å¯¾ã™ã‚‹æŒ‡ç¤ºã§ GM ã®æ¤œç´¢ãƒšãƒ¼ã‚¸ã§ä½•ã¨ã‹ãªã‚Šãã†ãªã‚‚ã®ã¯åŸºæœ¬çš„ã«ä¸è¨˜è¼‰';
      
            const bigLabels = document.querySelectorAll('.big-label');
            if (bigLabels && bigLabels[0]) bigLabels[0].textContent = 'æ›²ã‚’é¸æŠ';
      
            const smc = document.getElementById('search-method-container');
            if (smc) {
              const bl = smc.querySelector('.big-label');
              if (bl) bl.textContent = 'æ¤œç´¢æ–¹æ³•ã‚’é¸æŠ';
              const legend = smc.querySelector('legend');
              if (legend) legend.textContent = 'æ–¹æ³•';
              const labels = smc.querySelectorAll('label');
              labels.forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (!input) return;
                if (input.value === 'scene') label.lastChild.textContent = ' å ´é¢ã‹ã‚‰é¸æŠ';
                if (input.value === 'page') label.lastChild.textContent = ' ãƒšãƒ¼ã‚¸ã‹ã‚‰é¸æŠ';
              });
            }
      
            const psc = document.getElementById('page-selection-container');
            if (psc) {
              const legend2 = psc.querySelector('legend');
              if (legend2) legend2.textContent = 'ãƒšãƒ¼ã‚¸ç•ªå·';
              const note = psc.querySelector('p');
              if (note) note.textContent = 'ãƒšãƒ¼ã‚¸ç•ªå·ã‚’åŠè§’ã§å…¥åŠ›';
              const input = document.getElementById('page-input');
              if (input) input.setAttribute('placeholder', 'ä¾‹ 3,14,15-92');
            }
      
            const topBtn = document.getElementById('scrollToTop');
            if (topBtn) topBtn.textContent = 'â–² ãƒšãƒ¼ã‚¸ã®ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹';
          });
      
          // Create an alphabet floating bar for pages that have #navbar (notes/list)
          document.addEventListener('DOMContentLoaded', () => {
            try {
              const nav = document.getElementById('navbar');
              if (!nav) return;
              // Do not interfere with pages that already have a floating search bar
              if (document.getElementById('floating-bar')) return;
              // If alpha-floating-bar already exists in DOM (we may have added it server-side),
              // still run spacing adjustment.
              if (!document.getElementById('alpha-floating-bar')) {
                const alphaBar = document.createElement('div');
                alphaBar.id = 'alpha-floating-bar';
                // copy only link nodes to avoid other elements
                alphaBar.innerHTML = Array.from(nav.querySelectorAll('a')).map(a => a.outerHTML).join(' ');
                document.body.appendChild(alphaBar);
              }
      
              function adjustAlphaBarSpacing() {
                const bar = document.getElementById('alpha-floating-bar');
                const container = document.querySelector('.container');
                if (!bar || !container) return;
                // ensure bar is visible
                bar.style.display = 'flex';
                const barHeight = bar.offsetHeight || 56;
                container.style.paddingBottom = (barHeight + 24) + 'px';
              }
      
              // Throttled resize handler for alpha bar spacing
              const throttledAdjustSpacing = throttle(adjustAlphaBarSpacing, 200);
              window.addEventListener('resize', throttledAdjustSpacing);
              window.addEventListener('orientationchange', () => setTimeout(adjustAlphaBarSpacing, 120));
      
              // Run adjustment on load and shortly after to handle mobile viewport changes
              setTimeout(adjustAlphaBarSpacing, 50);
              setTimeout(adjustAlphaBarSpacing, 300);
            } catch (e) {
              console.error('alpha-floating-bar init failed', e);
            }
          });
        })();
        </script>
</body>

</html>
```