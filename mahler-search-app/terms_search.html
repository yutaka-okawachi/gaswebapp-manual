<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- レスポンシブ対応 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用語から検索 (GM)</title>
    <link rel="stylesheet" href="css/common.css">
    <script src="js/app.js?v=6"></script>

    <script>
        /*******************************************************************
         * クライアントサイドスクリプト（用語から検索ページ）
         * 
         * - 入力を監視してサーバーの searchEnglishTermsPartially() を呼び出し、
         *   suggest 用データを取得し datalist を更新
         * - 最終的に searchByTerm() を呼び出して結果を画面に表示
         ******************************************************************/

        // debounce(防振)用の関数：一定時間入力が止まるまで検索しないようにする
        function debounce(func, delay) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        let currentSearchId = 0;
        let termEntries = []; // { original, normalized } の配列を保持

        // Helper to normalize string (Inlined for robustness)
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                .replace(/ä/g, 'ae')
                .replace(/ö/g, 'oe')
                .replace(/ü/g, 'ue')
                .replace(/ß/g, 'ss')
                .replace(/[^a-z0-9.]/g, '');
        }

        // Helper to normalize term entry
        function normalizeTermEntry(term) {
            if (!term) return null;
            if (typeof term === 'string') {
                return { original: term, normalized: normalizeString(term) };
            }
            if (typeof term === 'object' && term.original) {
                return term;
            }
            return null;
        }

        // Ensure focusResultsPanel exists
        if (typeof window.focusResultsPanel !== 'function') {
            window.focusResultsPanel = function(options) {
                const resultsDiv = document.getElementById('results');
                if (!resultsDiv) return;
                const topOffset = Math.max((resultsDiv.getBoundingClientRect().top + window.scrollY) - 20, 0);
                const behavior = options && options.instant ? 'auto' : 'smooth';
                window.scrollTo({ top: topOffset, behavior });
            };
        }

        // DOM構築後に動作をセット
        window.addEventListener('DOMContentLoaded', async () => {
            const inputField = document.getElementById('termInput');
            // 入力フィールドに文字を入力するたびにイベント発火
            inputField.addEventListener('input', debouncedOnTermInput);

            // Load data locally first (needed for local search)
            if (typeof loadData === 'function') {
                await loadData('terms_search');
            }

            // ページ読み込み時に全用語リストを取得
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(terms => {
                        termEntries = (Array.isArray(terms) ? terms : [])
                            .map(term => normalizeTermEntry(term))
                            .filter(Boolean);
                        console.log(`${termEntries.length}件のGM用語を読み込みました。`);
                    })
                    .withFailureHandler(err => {
                        console.error('GM用語の取得に失敗しました:', err);
                        termEntries = [];
                    })
                    .getGMTermsForClient();
            } else {
                // Local fallback
                if (typeof getMahlerTermsListLocal === 'function') {
                    termEntries = getMahlerTermsListLocal();
                    console.log(`Loaded ${termEntries.length} terms locally.`);
                }
            }
        });

        // 入力があったら300ms後にサジェスト検索を実行する関数
        const debouncedOnTermInput = debounce((event) => {
            const input = event.target.value.trim();
            if (input.length < 2) {
                // 2文字未満ならサジェストをクリア
                document.getElementById('termSuggestions').innerHTML = '';
                return;
            }

            const normalizedInput = normalizeString(input);
            const matches = termEntries
                .filter(entry => entry.normalized.includes(normalizedInput))
                .sort((a, b) => a.normalized.localeCompare(b.normalized));

            updateDatalist(matches);

        }, 300);

        // datalist に候補を表示する
        function updateDatalist(suggestions) {
            const datalist = document.getElementById('termSuggestions');
            datalist.innerHTML = '';
            suggestions.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.normalized; // 入力欄は英字のまま
                option.label = entry.original;   // ユーザーには de 列の文字列を表示
                option.textContent = entry.original;
                datalist.appendChild(option);
            });
        }

        // 「検索」ボタン押下時
        function search() {
            const query = document.getElementById('termInput').value.trim();
            const resultsDiv = document.getElementById('results');
            const loadingHtml = '<p class="loading">検索中・・・</p>';
            resultsDiv.innerHTML = loadingHtml;
            if (typeof focusResultsPanel === 'function') {
                focusResultsPanel({ instant: true });
            }

            // 空文字チェック
            if (!query) {
                resultsDiv.innerHTML = '<p class="result-message">検索語句を入力してください。</p>';
                if (typeof focusResultsPanel === 'function') {
                    focusResultsPanel({ instant: true });
                }
                return;
            }

            currentSearchId++;
            const thisSearchId = currentSearchId;

            // Execute search (Local)
            setTimeout(() => {
                if (thisSearchId !== currentSearchId) return;
                
                if (typeof searchMahlerTermsLocal === 'function') {
                    const results = searchMahlerTermsLocal(query);
                    if (Array.isArray(results)) {
                        // Use LazyLoader
                        resultsDiv.innerHTML = `<div class="result-message">全部で${results.length}件ありました。</div><div id="term-results-list"></div>`;
                        new LazyLoader('term-results-list', results, renderTermItem);
                    } else {
                        // Fallback for string return (legacy)
                        resultsDiv.innerHTML = results;
                    }
                } else {
                    resultsDiv.innerHTML = '<div class="result-message">検索機能が見つかりません (searchMahlerTermsLocal missing)</div>';
                }
                
                if (typeof focusResultsPanel === 'function') {
                    focusResultsPanel({ instant: true });
                }

                // Send notification
                if (typeof sendSearchNotification === 'function') {
                    const details = {
                        work: 'All (GM)',
                        scope: 'Term',
                        term: query
                    };
                    sendSearchNotification(details, 'terms_search.html');
                }
            }, 10);
        }

        function cancelSearch() {
            currentSearchId++;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="result-message">検索を中止しました。</p>';
        }

        function clearInput() {
            document.getElementById('termInput').value = '';
            document.getElementById('termSuggestions').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('termInput').focus();
        }
    </script>
</head>

<body>
    <div class="container">
        <h1>用語から検索 (GM)</h1>
        <p style="text-align: center; font-weight: bold;">用語集は<a href="dic.html" target="_blank">こちら</a></p>
        <p>
            検索は英字入力なので，特殊文字の入力は慣例にしたがう<br>
        <ul>
            <li>ä⇒ae　例：Dämpfer⇒Daempfer</li>
            <li>ü⇒ue　例：zurückhalten⇒zurueckhalten</li>
            <li>ö⇒oe　例：Flöte⇒Floete</li>
            <li>ß⇒ss　例：fließend⇒fliessend</li>
        </ul>
        </p>

        <!-- 検索入力欄 -->
        <input type="text" id="termInput" list="termSuggestions" placeholder="検索する用語を入力">
        <datalist id="termSuggestions"></datalist>

        <!-- ボタン類 -->
        <div style="text-align: center;">
            <button type="button" onclick="search()" class="btn-search">検索</button>
            <button type="button" onclick="cancelSearch()" class="btn-danger">中止</button>
            <button type="button" onclick="clearInput()" class="clear-input-btn">入力をクリア</button>
        </div>

        <!-- 結果表示枠 -->
        <div id="results"></div>

        <!-- トップへ戻るボタン -->
        <div id="scrollToTop" onclick="scrollToTop()">▲ ページのトップへ戻る</div>
    </div>
</body>

</html>