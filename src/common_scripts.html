<script>
/*
 * common_scripts.html
 * 全ページで共通して使用されるクライアントサイドJavaScript。
 * 主に「トップへ戻る」ボタンの制御など、UIの基本的な動作を定義します。
 */
// Client-only helpers and UI glue. Guard against server (Apps Script) context.
(function() {
  if (typeof window === 'undefined' || typeof document === 'undefined') {
    // Define no-op globals so server-side references do not throw
    this.scrollToTop = function() {};
    this.setResults = function() {};
    return;
  }

  // Show/hide the "back to top" button — use class toggles and run on load/resize/scroll
  function updateScrollToTopVisibility() {
    const scrollToTopBtn = document.getElementById('scrollToTop');
    if (!scrollToTopBtn) return;
    // show when scrolled down a bit
    if (window.scrollY > 300) {
      scrollToTopBtn.classList.add('show');
      scrollToTopBtn.classList.remove('hidden');
    } else {
      scrollToTopBtn.classList.remove('show');
      scrollToTopBtn.classList.add('hidden');
    }
  }

  window.addEventListener('scroll', updateScrollToTopVisibility, { passive: true });
  window.addEventListener('resize', () => setTimeout(updateScrollToTopVisibility, 120));
  window.addEventListener('orientationchange', () => setTimeout(updateScrollToTopVisibility, 160));

  // ensure initial state after load (some mobile browsers change viewport after load)
  window.addEventListener('load', () => {
    updateScrollToTopVisibility();
    // second check shortly after to account for browser UI show/hide
    setTimeout(updateScrollToTopVisibility, 300);
  });

  // Expose global helpers
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  window.scrollToTop = scrollToTop;

  function focusResultsPanel(options) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;

    const topOffset = Math.max((resultsDiv.getBoundingClientRect().top + window.scrollY) - 20, 0);
    const behavior = options && options.instant ? 'auto' : 'smooth';
    window.scrollTo({ top: topOffset, behavior });
  }
  window.focusResultsPanel = focusResultsPanel;

  function setResults(html) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    resultsDiv.innerHTML = html;
    focusResultsPanel({ instant: true });
  }
  window.setResults = setResults;

  // Fix garbled static texts for Wagner/Strauss pages
  document.addEventListener('DOMContentLoaded', () => {
    const isComposerPage = /Richard Wagner|Richard Strauss/.test(document.title);
    if (!isComposerPage) return;

    const firstP = document.querySelector('.container > p');
    if (firstP) firstP.textContent = 'オーケストラに対する指示で GM の検索ページで何とかなりそうなものは基本的に不記載';

    const bigLabels = document.querySelectorAll('.big-label');
    if (bigLabels && bigLabels[0]) bigLabels[0].textContent = '曲を選択';

    const smc = document.getElementById('search-method-container');
    if (smc) {
      const bl = smc.querySelector('.big-label');
      if (bl) bl.textContent = '検索方法を選択';
      const legend = smc.querySelector('legend');
      if (legend) legend.textContent = '方法';
      const labels = smc.querySelectorAll('label');
      labels.forEach(label => {
        const input = label.querySelector('input[type="radio"]');
        if (!input) return;
        if (input.value === 'scene') label.lastChild.textContent = ' 場面から選択';
        if (input.value === 'page') label.lastChild.textContent = ' ページから選択';
      });
    }

    const psc = document.getElementById('page-selection-container');
    if (psc) {
      const legend2 = psc.querySelector('legend');
      if (legend2) legend2.textContent = 'ページ番号';
      const note = psc.querySelector('p');
      if (note) note.textContent = 'ページ番号を半角で入力';
      const input = document.getElementById('page-input');
      if (input) input.setAttribute('placeholder', '例 3,14,15-92');
    }

    const topBtn = document.getElementById('scrollToTop');
    if (topBtn) topBtn.textContent = '▲ ページのトップへ戻る';
  });
})();
</script>
