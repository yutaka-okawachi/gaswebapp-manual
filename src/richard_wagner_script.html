<script>
  /*
   * richard_wagner_script.html
   * 共通JS: リヒャルト・ワーグナー／リヒャルト・シュトラウス「曲名から検索」ページで
   * オペラ選択・検索方法切り替え・場面データ取得・検索実行を担当。
   */

  const sceneOptionsCache = {};
  const targetOptionsCache = {};
  const resultsCache = {};
  let currentSearchId = 0;

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="opera"]').forEach(radio => {
      radio.addEventListener('change', handleOperaSelection);
    });
    document.querySelectorAll('input[name="search-type"]').forEach(radio => {
      radio.addEventListener('change', handleSearchTypeSelection);
    });
  });

  /**
   * オペラ（曲名）が選択されたときの処理
   */
  function handleOperaSelection(event) {
    const operaValue = event.target.value;
    const composer = document.title.includes('Wagner') ? 'richard_wagner' : 'richard_strauss';

    // 検索方法セクションを表示し初期化
    document.getElementById('search-method-container').style.display = 'block';
    document.getElementById('shared-button-container').style.display = 'block';
    resetSearchType();

    const sceneOptionsWrapper = document.getElementById('scene-options-wrapper');
    sceneOptionsWrapper.innerHTML = '<p class="loading">場面データを読み込み中...</p>';
    
    const targetCheckboxes = document.getElementById('target-checkboxes');
    targetCheckboxes.innerHTML = '<p class="loading">指示対象データを読み込み中...</p>';

    // 場面データの取得
    if (sceneOptionsCache[composer]) {
      buildSceneCheckboxes(operaValue, sceneOptionsCache[composer]);
    } else {
      google.script.run
        .withSuccessHandler(options => {
          sceneOptionsCache[composer] = options || {};
          buildSceneCheckboxes(operaValue, sceneOptionsCache[composer]);
        })
        .getSceneOptionsForOpera(composer);
    }

    // 指示対象データの取得
    const targetFuncName = composer === 'richard_wagner' ? 'getWagnerTargets' : 'getStraussTargets';
    google.script.run
      .withSuccessHandler(targets => {
        buildTargetCheckboxes(targets);
      })
      .withFailureHandler(err => {
        console.error('指示対象データの取得に失敗しました', err);
        targetCheckboxes.innerHTML = '<p class="result-message">指示対象データの取得に失敗しました</p>';
      })[targetFuncName](operaValue);
  }

  /**
   * 取得した場面データをもとにチェックボックス群を描画
   */
  function buildSceneCheckboxes(operaValue, sceneOptionsData) {
    const wrapper = document.getElementById('scene-options-wrapper');
    wrapper.innerHTML = '';
    const options = sceneOptionsData[operaValue];

    if (!options || options.length === 0) {
      wrapper.innerHTML = '<p>この曲の場面データは登録されていません。</p>';
      return;
    }

    const checkboxGroup = document.createElement('div');
    checkboxGroup.className = 'checkbox-group';

    // 「すべて」チェックボックス
    checkboxGroup.innerHTML += `<label><input type="checkbox" name="scene" value="all"> すべて</label>`;
    if (options.length > 1) {
      checkboxGroup.innerHTML += '<hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">';
    }

    options.forEach(opt => {
      checkboxGroup.innerHTML += `<label><input type="checkbox" name="scene" value="${opt.value}"> ${opt.text}</label>`;
    });

    wrapper.appendChild(checkboxGroup);

    // 「すべて」の排他制御
    const sceneCheckboxes = wrapper.querySelectorAll('input[name="scene"]');
    const allCheckbox = wrapper.querySelector('input[name="scene"][value="all"]');
    sceneCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        if (cb.value === 'all' && cb.checked) {
          sceneCheckboxes.forEach(other => { if (other.value !== 'all') other.checked = false; });
        } else if (cb.value !== 'all' && cb.checked && allCheckbox) {
          allCheckbox.checked = false;
        }
      });
    });
  }

  /**
   * 指示対象のチェックボックスを描画
   */
  function buildTargetCheckboxes(targets) {
    const wrapper = document.getElementById('target-checkboxes');
    wrapper.innerHTML = '';

    if (!targets || targets.length === 0) {
      wrapper.innerHTML = '<p>指示対象データが見つかりませんでした。</p>';
      return;
    }

    targets.forEach(target => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" name="target-item" value="${target}"> ${target}`;
      wrapper.appendChild(label);
    });
  }

  /**
   * 検索方法が選択されたときの処理
   */
  function handleSearchTypeSelection() {
    const selectedType = document.querySelector('input[name="search-type"]:checked')?.value;
    document.getElementById('scene-selection-container').style.display = selectedType === 'scene' ? 'block' : 'none';
    document.getElementById('page-selection-container').style.display = selectedType === 'page' ? 'block' : 'none';
    document.getElementById('target-selection-container').style.display = selectedType === 'target' ? 'block' : 'none';
    setResults('');
  }

  /**
   * 検索実行
   */
  function executeSearch() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) {
      setResults('<p class="result-message">曲を選択してください</p>');
      return;
    }

    const selectedType = document.querySelector('input[name="search-type"]:checked')?.value;
    if (!selectedType) {
      setResults('<p class="result-message">検索方法を選択してください</p>');
      return;
    }

    const operaValue = selectedOpera.value;
    const composer = document.title.includes('Wagner') ? 'RichardWagner' : 'RichardStrauss';
    
    let funcName = '';
    let params = [];

    if (selectedType === 'scene') {
      const selectedScenes = Array.from(document.querySelectorAll('input[name="scene"]:checked')).map(cb => cb.value);
      if (selectedScenes.length === 0) {
        setResults('<p class="result-message">場面を選択してください</p>');
        return;
      }
      funcName = `search${composer}ByScene`;
      params = [operaValue, selectedScenes];
    } else if (selectedType === 'page') {
      const pageInput = document.getElementById('page-input').value.trim();
      if (!pageInput) {
        setResults('<p class="result-message">ページ番号を入力してください</p>');
        return;
      }
      funcName = `search${composer}ByPage`;
      params = [operaValue, pageInput];
    } else if (selectedType === 'target') {
      const selectedTargets = Array.from(document.querySelectorAll('input[name="target-item"]:checked')).map(cb => cb.value);
      if (selectedTargets.length === 0) {
        setResults('<p class="result-message">指示対象を選択してください</p>');
        return;
      }
      funcName = `search${composer}ByTarget`;
      params = [operaValue, selectedTargets];
    }

    setResults('<p class="loading">検索中...</p>');
    document.getElementById('search-button').disabled = true;
    
    currentSearchId++;
    const thisSearchId = currentSearchId;

    google.script.run
      .withSuccessHandler(html => {
        if (thisSearchId === currentSearchId) setResults(html);
        document.getElementById('search-button').disabled = false;
      })
      .withFailureHandler(err => {
        if (thisSearchId === currentSearchId) {
          setResults(`<p class="result-message">検索に失敗しました: ${err.message}</p>`);
        }
        document.getElementById('search-button').disabled = false;
      })[funcName](...params);
  }

  function cancelSearch() {
    currentSearchId++;
    setResults('<p class="loading">検索を中止しました</p>');
    document.getElementById('search-button').disabled = false;
  }

  function clearInputs() {
    // 場面リセット
    document.querySelectorAll('input[name="scene"]').forEach(cb => cb.checked = false);
    // ページリセット
    document.getElementById('page-input').value = '';
    // 指示対象リセット
    document.querySelectorAll('input[name="target-item"]').forEach(cb => cb.checked = false);
    setResults('');
  }

  function resetSearchType() {
    document.querySelectorAll('input[name="search-type"]').forEach(radio => (radio.checked = false));
    document.getElementById('scene-selection-container').style.display = 'none';
    document.getElementById('page-selection-container').style.display = 'none';
    document.getElementById('target-selection-container').style.display = 'none';
    setResults('');
  }

  function setResults(html) {
    document.getElementById('results').innerHTML = html;
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
</script>

