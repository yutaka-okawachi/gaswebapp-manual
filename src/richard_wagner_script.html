<script>
  // このスクリプトは richard_wagner.html と richard_strauss.html で共用されます。
  // オペラごとの場面データをキャッシュするオブジェクト
  let sceneOptionsCache = {};
  let currentSearchId = 0;

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="opera"]').forEach(radio => {
      radio.addEventListener('change', handleOperaSelection);
    });
    document.querySelectorAll('input[name="search-type"]').forEach(radio => {
      radio.addEventListener('change', handleSearchTypeSelection);
    });
  });

  // オペラ（曲名）が選択されたときの処理
  function handleOperaSelection(event) {
    const operaValue = event.target.value;
    // ページタイトルから作曲家を判別
    const composer = document.title.includes('Wagner') ? 'richard_wagner' : 'richard_strauss';

    // 「検索方法」セクションを表示
    document.getElementById('search-method-container').style.display = 'block';
    resetSearchType();

    const sceneOptionsWrapper = document.getElementById('scene-options-wrapper');
    sceneOptionsWrapper.innerHTML = '<p class="loading">場面データを読み込み中...</p>';

    // キャッシュがあればそれを使う
    if (sceneOptionsCache[composer]) {
      buildSceneCheckboxes(operaValue, sceneOptionsCache[composer]);
      return;
    }

    // サーバから場面データを取得
    google.script.run
      .withSuccessHandler(options => {
        sceneOptionsCache[composer] = options; // 結果をキャッシュ
        buildSceneCheckboxes(operaValue, options);
      })
      .withFailureHandler(err => {
        console.error('場面データの取得に失敗', err);
        sceneOptionsWrapper.innerHTML = '<p class="result-message">場面データの取得に失敗しました</p>';
      })
      .getSceneOptionsForOpera(composer);
  }

  // 取得した場面データをもとにチェックボックスを生成
  function buildSceneCheckboxes(opera, sceneOptionsData) {
    const wrapper = document.getElementById('scene-options-wrapper');
    wrapper.innerHTML = '';

    const options = sceneOptionsData[opera];

    if (!options || options.length === 0) {
      wrapper.innerHTML = '<p>この曲の場面データは登録されていません</p>';
      return;
    }

    const checkboxGroup = document.createElement('div');
    checkboxGroup.className = 'checkbox-group';

    // 「すべて」チェックボックスを追加
    let allCheckboxHTML = `<label><input type="checkbox" name="${opera}-scene" value="all"> すべて</label>`;
    checkboxGroup.innerHTML += allCheckboxHTML;
    if (options.length > 1) {
      checkboxGroup.innerHTML += '<hr>';
    }

    // 各場面のチェックボックスを追加
    options.forEach(opt => {
      const checkboxHTML = `<label><input type="checkbox" name="${opera}-scene" value="${opt.value}"> ${opt.text}</label>`;
      checkboxGroup.innerHTML += checkboxHTML;
    });

    wrapper.appendChild(checkboxGroup);

    // 「すべて」チェックボックスの排他制御
    const sceneCheckboxes = wrapper.querySelectorAll(`input[name="${opera}-scene"]`);
    if (sceneCheckboxes.length > 1) {
      const allCheckbox = wrapper.querySelector(`input[name="${opera}-scene"][value="all"]`);
      sceneCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.value === 'all' && cb.checked) {
            sceneCheckboxes.forEach(other => {
              if (other.value !== 'all') other.checked = false;
            });
          } else if (cb.value !== 'all' && cb.checked) {
            if (allCheckbox) allCheckbox.checked = false;
          }
        });
      });
    }
  }

  // 検索方法（場面／ページ）が選択されたときの処理
  function handleSearchTypeSelection(event) {
    document.getElementById('scene-selection-container').style.display = event.target.value === 'scene' ? 'block' : 'none';
    document.getElementById('page-selection-container').style.display = event.target.value === 'page' ? 'block' : 'none';
  }

  // 検索方法の選択をリセット
  function resetSearchType() {
    document.querySelectorAll('input[name="search-type"]').forEach(radio => (radio.checked = false));
    document.getElementById('scene-selection-container').style.display = 'none';
    document.getElementById('page-selection-container').style.display = 'none';
    setResults('');
  }

  // 場面で検索
  function searchByScene() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) {
      setResults('<p class="result-message">曲を選択してください</p>');
      return;
    }
    const operaValue = selectedOpera.value;
    const sceneCheckboxes = document.querySelectorAll(`input[name="${operaValue}-scene"]:checked`);
    const selectedScenes = Array.from(sceneCheckboxes).map(cb => cb.value);
    if (selectedScenes.length === 0) {
      setResults('<p class="result-message">場面を選択してください</p>');
      return;
    }
    setResults('<p class="loading">検索中・・・</p>');
    currentSearchId++;
    const thisSearchId = currentSearchId;

    const funcName = document.title.includes('Wagner') ? 'searchRichardWagnerByScene' : 'searchRichardStraussByScene';

    google.script.run
      .withSuccessHandler(html => {
        if (thisSearchId === currentSearchId) setResults(html);
      })
      .withFailureHandler(err => {
        if (thisSearchId === currentSearchId) setResults(`<p class="result-message">検索に失敗しました: ${err.message}</p>`);
      })
    [funcName](operaValue, selectedScenes);
  }

  // ページ番号で検索
  function searchByPage() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) {
      setResults('<p class="result-message">曲を選択してください</p>');
      return;
    }
    const operaValue = selectedOpera.value;
    const pageInput = document.getElementById('page-input').value.trim();
    if (!pageInput) {
      setResults('<p class="result-message">ページ番号を入力してください</p>');
      return;
    }
    setResults('<p class="loading">検索中・・・</p>');
    currentSearchId++;
    const thisSearchId = currentSearchId;

    const funcName = document.title.includes('Wagner') ? 'searchRichardWagnerByPage' : 'searchRichardStraussByPage';

    google.script.run
      .withSuccessHandler(html => {
        if (thisSearchId === currentSearchId) setResults(html);
      })
      .withFailureHandler(err => {
        if (thisSearchId === currentSearchId) setResults(`<p class="result-message">検索に失敗しました: ${err.message}</p>`);
      })
    [funcName](operaValue, pageInput);
  }

  function cancelSearch() {
    currentSearchId++;
    setResults('<p class="loading">検索を中止しました</p>');
  }

  function clearScenes() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) return;
    const operaValue = selectedOpera.value;
    const sceneCheckboxes = document.querySelectorAll(`input[name="${operaValue}-scene"]`);
    sceneCheckboxes.forEach(cb => {
      cb.checked = false;
    });
    setResults('');
  }

  function clearPageInput() {
    document.getElementById('page-input').value = '';
    setResults('');
  }
</script>